/**
 * almond 0.2.6 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/*
	object-assign
	(c) Sindre Sorhus
	@license MIT
	*/

/*
	    StackBlur - a fast almost Gaussian Blur For Canvas

	    Version:     0.5
	    Author:        Mario Klingemann
	    Contact:     mario@quasimondo.com
	    Website:    http://www.quasimondo.com/StackBlurForCanvas
	    Twitter:    @quasimondo

	    In case you find this class useful - especially in commercial projects -
	    I am not totally unhappy for a small donation to my PayPal account
	    mario@quasimondo.de

	    Or support me on flattr:
	    https://flattr.com/thing/72791/StackBlur-a-fast-almost-Gaussian-Blur-Effect-for-CanvasJavascript

	    Copyright (c) 2010 Mario Klingemann

	    Permission is hereby granted, free of charge, to any person
	    obtaining a copy of this software and associated documentation
	    files (the "Software"), to deal in the Software without
	    restriction, including without limitation the rights to use,
	    copy, modify, merge, publish, distribute, sublicense, and/or sell
	    copies of the Software, and to permit persons to whom the
	    Software is furnished to do so, subject to the following
	    conditions:

	    The above copyright notice and this permission notice shall be
	    included in all copies or substantial portions of the Software.

	    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
	    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
	    OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
	    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
	    HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
	    WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
	    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
	    OTHER DEALINGS IN THE SOFTWARE.
	    */

/*!
	 * @overview es6-promise - a tiny implementation of Promises/A+.
	 * @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors (Conversion to ES6 API by Jake Archibald)
	 * @license   Licensed under MIT license
	 *            See https://raw.githubusercontent.com/stefanpenner/es6-promise/master/LICENSE
	 * @version   4.1.0
	 */

/** @license
 * JS Signals <http://millermedeiros.github.com/js-signals/>
 * Released under the MIT license
 * Author: Miller Medeiros
 * Version: 1.0.0 - Build: 268 (2012/11/29 05:48 PM)
 */

(function(){var requirejs,require,define;(function(e){function c(e,t){return f.call(e,t)}function h(e,t){var n,r,i,s,o,a,f,l,c,h,p=t&&t.split("/"),d=u.map,v=d&&d["*"]||{};if(e&&e.charAt(0)===".")if(t){p=p.slice(0,p.length-1),e=p.concat(e.split("/"));for(l=0;l<e.length;l+=1){h=e[l];if(h===".")e.splice(l,1),l-=1;else if(h===".."){if(l===1&&(e[2]===".."||e[0]===".."))break;l>0&&(e.splice(l-1,2),l-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((p||v)&&d){n=e.split("/");for(l=n.length;l>0;l-=1){r=n.slice(0,l).join("/");if(p)for(c=p.length;c>0;c-=1){i=d[p.slice(0,c).join("/")];if(i){i=i[r];if(i){s=i,o=l;break}}}if(s)break;!a&&v&&v[r]&&(a=v[r],f=l)}!s&&a&&(s=a,o=f),s&&(n.splice(0,o,s),e=n.join("/"))}return e}function p(t,r){return function(){return n.apply(e,l.call(arguments,0).concat([t,r]))}}function d(e){return function(t){return h(t,e)}}function v(e){return function(t){s[e]=t}}function m(n){if(c(o,n)){var r=o[n];delete o[n],a[n]=!0,t.apply(e,r)}if(!c(s,n)&&!c(a,n))throw new Error("No "+n);return s[n]}function g(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function y(e){return function(){return u&&u.config&&u.config[e]||{}}}var t,n,r,i,s={},o={},u={},a={},f=Object.prototype.hasOwnProperty,l=[].slice;r=function(e,t){var n,r=g(e),i=r[0];return e=r[1],i&&(i=h(i,t),n=m(i)),i?n&&n.normalize?e=n.normalize(e,d(t)):e=h(e,t):(e=h(e,t),r=g(e),i=r[0],e=r[1],i&&(n=m(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},i={require:function(e){return p(e)},exports:function(e){var t=s[e];return typeof t!="undefined"?t:s[e]={}},module:function(e){return{id:e,uri:"",exports:s[e],config:y(e)}}},t=function(t,n,u,f){var l,h,d,g,y,b=[],w;f=f||t;if(typeof u=="function"){n=!n.length&&u.length?["require","exports","module"]:n;for(y=0;y<n.length;y+=1){g=r(n[y],f),h=g.f;if(h==="require")b[y]=i.require(t);else if(h==="exports")b[y]=i.exports(t),w=!0;else if(h==="module")l=b[y]=i.module(t);else if(c(s,h)||c(o,h)||c(a,h))b[y]=m(h);else{if(!g.p)throw new Error(t+" missing "+h);g.p.load(g.n,p(f,!0),v(h),{}),b[y]=s[h]}}d=u.apply(s[t],b);if(t)if(l&&l.exports!==e&&l.exports!==s[t])s[t]=l.exports;else if(d!==e||!w)s[t]=d}else t&&(s[t]=u)},requirejs=require=n=function(s,o,a,f,l){return typeof s=="string"?i[s]?i[s](o):m(r(s,o).f):(s.splice||(u=s,o.splice?(s=o,o=a,a=null):s=e),o=o||function(){},typeof a=="function"&&(a=f,f=l),f?t(e,s,o,a):setTimeout(function(){t(e,s,o,a)},4),n)},n.config=function(e){return u=e,u.deps&&n(u.deps,u.callback),n},requirejs._defined=s,define=function(e,t,n){t.splice||(n=t,t=[]),!c(s,e)&&!c(o,e)&&(o[e]=[e,t,n])},define.amd={jQuery:!0}})(),define("lib/almond-0.2.6",function(){}),function(e,t){typeof exports=="object"&&typeof module!="undefined"?module.exports=t():typeof define=="function"&&define.amd?define("lib/triangulate-image-browser-with-polyfills",t):(e=e||self,e.triangulate=t())}(this,function(){"use strict";function e(e,t,n){return e<t?t:e>n?n:e}function t(e){var t=!1;if(typeof e!="undefined")try{t=JSON.parse(JSON.stringify(e))}catch(n){}return t}function i(e,t,r,i){var s=t&&t.backgroundColor?t.backgroundColor:!1,o=new n(e.width*r,e.height*r,i),u=o.getContext("2d");return s&&(u.fillStyle=s,u.fillRect(0,0,e.width*r,e.height*r),u.fillStyle="transparent"),{canvas:o,ctx:u}}function s(e){var t=1,n=i({width:t,height:t},{},1,!0).ctx;n.fillStyle=e,n.fillRect(0,0,t,t);var r=n.getImageData(0,0,t,t).data;return{r:r[0],g:r[1],b:r[2],a:r[3]/255}}function a(n){n=t(n),typeof n!="object"&&(n={}),typeof n.accuracy!="number"||isNaN(n.accuracy)?n.accuracy=o.accuracy:n.accuracy=e(n.accuracy,0,1);if(typeof n.blur!="number"||isNaN(n.blur))n.blur=o.blur;n.blur<=0&&(n.blur=1),typeof n.fill!="string"&&typeof n.fill!="boolean"&&(n.fill=o.fill),typeof n.stroke!="string"&&typeof n.stroke!="boolean"&&(n.stroke=o.stroke);if(typeof n.strokeWidth!="number"||isNaN(n.strokeWidth))n.strokeWidth=o.strokeWidth;typeof n.threshold!="number"||isNaN(n.threshold)?n.threshold=o.threshold:n.threshold=e(n.threshold,1,100);if(typeof n.lineJoin!="string"||u.indexOf(n.lineJoin)===-1)n.lineJoin=o.lineJoin;n.gradients&&n.fill?n.gradients=!0:n.gradients=!1;if(n.gradients){if(typeof n.gradientStops!="number"||isNaN(n.gradientStops)||n.gradientStops<2)n.gradientStops=2;n.gradientStops=Math.round(n.gradientStops)}if(typeof n.vertexCount!="number"||isNaN(n.vertexCount))n.vertexCount=o.vertexCount;return n.vertexCount<=0&&(n.vertexCount=1),typeof n.transparentColor!="string"&&typeof n.transparentColor!="boolean"&&(n.transparentColor=o.transparentColor),typeof n.transparentColor===!0&&(n.transparentColor=!1),typeof n.transparentColor=="string"&&(n.transparentColor=s(n.transparentColor)),n}function f(e){if(e instanceof HTMLImageElement){if(!e.naturalWidth||!e.naturalHeight||e.complete===!1)throw new Error("This this image hasn't finished loading: "+e.src);var t=new n(e.naturalWidth,e.naturalHeight),r=t.getContext("2d");r.drawImage(e,0,0,t.width,t.height);var i=r.getImageData(0,0,t.width,t.height);return i.data&&i.data.length&&(typeof i.width=="undefined"&&(i.width=e.naturalWidth),typeof i.height=="undefined"&&(i.height=e.naturalHeight)),i}throw new Error("This object does not seem to be an image.")}function p(e){if(e===null||e===undefined)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}function d(){try{if(!Object.assign)return!1;var e=new String("abc");e[5]="de";if(Object.getOwnPropertyNames(e)[0]==="5")return!1;var t={};for(var n=0;n<10;n++)t["_"+String.fromCharCode(n)]=n;var r=Object.getOwnPropertyNames(t).map(function(e){return t[e]});if(r.join("")!=="0123456789")return!1;var i={};return"abcdefghijklmnopqrst".split("").forEach(function(e){i[e]=e}),Object.keys(Object.assign({},i)).join("")!=="abcdefghijklmnopqrst"?!1:!0}catch(s){return!1}}function m(e){var t=v({a:1},e);return"rgba("+t.r+", "+t.g+", "+t.b+", "+t.a+")"}function g(e,t,n,r){return r=r||1,t.forEach(function(t,n){e.beginPath(),e.moveTo(t.a.x*r,t.a.y*r),e.lineTo(t.b.x*r,t.b.y*r),e.lineTo(t.c.x*r,t.c.y*r),e.lineTo(t.a.x*r,t.a.y*r);if(t.gradient){var i=e.createLinearGradient(t.gradient.x1*r,t.gradient.y1*r,t.gradient.x2*r,t.gradient.y2*r),s=t.gradient.colors.length-1;t.gradient.colors.forEach(function(e,t){var n=m(e);console.log(e),i.addColorStop(t/s,n)}),e.fillStyle=i,e.fill(),t.strokeWidth>0&&(e.strokeStyle=i,e.lineWidth=t.strokeWidth*r,e.lineJoin=t.lineJoin,e.stroke())}else t.fill&&(e.fillStyle=m(t.fill),e.fill()),t.strokeColor&&(e.strokeStyle=m(t.strokeColor),e.lineWidth=t.strokeWidth*r,e.lineJoin=t.lineJoin,e.stroke());e.closePath()}),e}function y(e,t,n){var r=n&&n.dpr?n.dpr:1,s=i(t,n,r,!0).ctx;return g(s,e,t,r),s.getImageData(0,0,t.width*r,t.height*r)}function b(e,t,n){var r=n&&n.dpr?n.dpr:1,s=i(t,n,r);return g(s.ctx,e,t,r),s.canvas.toDataURL()}function w(e){var t=e.toString(16);return t.length==1?"0"+t:t}function E(e){var t=e.r,n=e.g,r=e.b;return"#"+w(t)+w(n)+w(r)}function S(e,t){var n="";e.length&&e[0].gradient&&(n="<defs>");var r="";e.forEach(function(e,t){var i=e.a,s=e.b,o=e.c;r+='<polygon points="'+i.x+","+i.y+" "+s.x+","+s.y+" "+o.x+","+o.y+'"';if(e.gradient){var u=e.boundingBox,a=((e.gradient.x1-u.x)/u.width*100).toFixed(3),f=((e.gradient.y1-u.y)/u.height*100).toFixed(3),l=((e.gradient.x2-u.x)/u.width*100).toFixed(3),c=((e.gradient.y2-u.y)/u.height*100).toFixed(3);n+='\n	<linearGradient id="gradient-'+t+'" x1="'+a+'%" y1="'+f+'%" x2="'+l+'%" y2="'+c+'%">';var h=e.gradient.colors.length-1;e.gradient.colors.forEach(function(e,t){var r=E(e),i=e.a<1?' stop-opacity="'+e.a+'"':"",s=(t/h*100).toFixed(3);n+='\n					<stop offset="'+s+'%" stop-color="'+r+'"'+i+"/>\n				"}),n+="</linearGradient>",r+=' fill="url(#gradient-'+t+')"',e.strokeWidth>0&&(r+=' stroke="url(#gradient-'+t+')" stroke-width="'+e.strokeWidth+'" stroke-linejoin="'+e.lineJoin+'"')}else{if(e.fill){var p=E(e.fill),d=e.fill.a<1?' fill-opacity="'+e.fill.a+'"':"";r+=' fill="'+p+'"'+d}else r+=' fill="transparent"';if(e.strokeColor){var v=E(e.strokeColor),m=e.strokeColor.a<1?' stroke-opacity="'+e.strokeColor.a+'"':"";r+=' stroke="'+v+'" stroke-width="'+e.strokeWidth+'" stroke-linejoin="'+e.lineJoin+'"'+m}}r+="/>\n	"}),n.length&&(n+="\n		</defs>");var i='<?xml version="1.0" standalone="yes"?>\n<svg width="'+t.width+'" height="'+t.height+'" xmlns="http://www.w3.org/2000/svg" version="1.1" >\n	'+n+"\n	"+r+"\n</svg>";return i}function T(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}function N(e,t){return t={exports:{}},e(t,t.exports),t.exports}function M(e){return e&&typeof e.width=="number"&&typeof e.height=="number"&&e.data&&typeof e.data.length=="number"&&typeof e.data=="object"}function _(e){if(M(e)){if(typeof Uint8ClampedArray=="undefined"){if(typeof window=="undefined")throw new Error("Can't copy imageData in webworker without Uint8ClampedArray support.");return D(e)}var t=new Uint8ClampedArray(e.data);if(typeof ImageData=="undefined")return{width:e.width,height:e.height,data:t};var n;try{n=new ImageData(t,e.width,e.height)}catch(r){if(typeof window=="undefined")throw new Error("Can't copy imageData in webworker without proper ImageData() support.");n=D(e)}return n}throw new Error("Given imageData object is not useable.")}function D(e){var t=new n(e.width,e.height),r=t.getContext("2d");return r.putImageData(e,0,0),r.getImageData(0,0,e.width,e.height)}function B(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}function j(e,t,n,r,i,s){var o=e.data,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M=s+s+1,_=r-1,D=i-1,j=s+1,F=j*(j+1)/2,I=new B,q=I;for(f=1;f<M;f++){q=q.next=new B;if(f==j)var R=q}q.next=I;var U=null,z=null;p=h=0;var W=P[s],X=H[s];for(a=0;a<i;a++){S=x=T=N=d=v=m=g=0,y=j*(C=o[h]),b=j*(k=o[h+1]),w=j*(L=o[h+2]),E=j*(A=o[h+3]),d+=F*C,v+=F*k,m+=F*L,g+=F*A,q=I;for(f=0;f<j;f++)q.r=C,q.g=k,q.b=L,q.a=A,q=q.next;for(f=1;f<j;f++)l=h+((_<f?_:f)<<2),d+=(q.r=C=o[l])*(O=j-f),v+=(q.g=k=o[l+1])*O,m+=(q.b=L=o[l+2])*O,g+=(q.a=A=o[l+3])*O,S+=C,x+=k,T+=L,N+=A,q=q.next;U=I,z=R;for(u=0;u<r;u++)o[h+3]=A=g*W>>X,A!=0?(A=255/A,o[h]=(d*W>>X)*A,o[h+1]=(v*W>>X)*A,o[h+2]=(m*W>>X)*A):o[h]=o[h+1]=o[h+2]=0,d-=y,v-=b,m-=w,g-=E,y-=U.r,b-=U.g,w-=U.b,E-=U.a,l=p+((l=u+s+1)<_?l:_)<<2,S+=U.r=o[l],x+=U.g=o[l+1],T+=U.b=o[l+2],N+=U.a=o[l+3],d+=S,v+=x,m+=T,g+=N,U=U.next,y+=C=z.r,b+=k=z.g,w+=L=z.b,E+=A=z.a,S-=C,x-=k,T-=L,N-=A,z=z.next,h+=4;p+=r}for(u=0;u<r;u++){x=T=N=S=v=m=g=d=0,h=u<<2,y=j*(C=o[h]),b=j*(k=o[h+1]),w=j*(L=o[h+2]),E=j*(A=o[h+3]),d+=F*C,v+=F*k,m+=F*L,g+=F*A,q=I;for(f=0;f<j;f++)q.r=C,q.g=k,q.b=L,q.a=A,q=q.next;c=r;for(f=1;f<=s;f++)h=c+u<<2,d+=(q.r=C=o[h])*(O=j-f),v+=(q.g=k=o[h+1])*O,m+=(q.b=L=o[h+2])*O,g+=(q.a=A=o[h+3])*O,S+=C,x+=k,T+=L,N+=A,q=q.next,f<D&&(c+=r);h=u,U=I,z=R;for(a=0;a<i;a++)l=h<<2,o[l+3]=A=g*W>>X,A>0?(A=255/A,o[l]=(d*W>>X)*A,o[l+1]=(v*W>>X)*A,o[l+2]=(m*W>>X)*A):o[l]=o[l+1]=o[l+2]=0,d-=y,v-=b,m-=w,g-=E,y-=U.r,b-=U.g,w-=U.b,E-=U.a,l=u+((l=a+j)<D?l:D)*r<<2,d+=S+=U.r=o[l],v+=x+=U.g=o[l+1],m+=T+=U.b=o[l+2],g+=N+=U.a=o[l+3],U=U.next,y+=C=z.r,b+=k=z.g,w+=L=z.b,E+=A=z.a,S-=C,x-=k,T-=L,N-=A,z=z.next,h+=r}return e}function F(e){var t=e.data.length,n;for(var r=0;r<t;r+=4)n=.34*e.data[r]+.5*e.data[r+1]+.16*e.data[r+2],e.data[r]=n,e.data[r+1]=n,e.data[r+2]=n;return e}function I(e,t){var n=2,r=e.width,i=e.height,s=e.data,o=[],u,a,f,l,c,h,p,d,v;for(a=0;a<i;a+=n)for(u=0;u<r;u+=n){d=v=0;for(f=-1;f<=1;f++){h=a+f,p=h*r;if(h>=0&&h<i)for(l=-1;l<=1;l++)c=u+l,c>=0&&c<r&&(d+=s[c+p<<2],v++)}v&&(d/=v),d>t&&o.push({x:u,y:a})}return o}function q(e,t,n){var r=e+"|"+t;n[r]||(n[r]={x:e,y:t}),r=null}function R(e,t,n,r,i){var s={},o=Math.max(~~(t*(1-n)),5),u=Math.round(Math.sqrt(o)),a=Math.round(Math.ceil(o/u)),f=~~(r/u),l=~~(i/a),c=0,h=0,p=0,d=0;for(d=0;d<i;d+=l){c++,h=c%2===0?~~(f/2):0;for(p=h;p<r;p+=f)p<r&&d<i&&q(~~(p+Math.cos(d)*l),~~(d+Math.sin(p)*f),s)}q(0,0,s),q(r-1,0,s),q(r-1,i-1,s),q(0,i-1,s);var v=t-Object.keys(s).length,m=e.length,g=~~(m/v);if(t>0&&g>0){var y=0;for(y=0;y<m;y+=g)q(e[y].x,e[y].y,s)}return e=null,Object.keys(s).map(function(e){return s[e]})}function U(e){var t=Infinity,n=-Infinity,r=Infinity,i=-Infinity;return e.forEach(function(e){e.x<t&&(t=e.x),e.y<r&&(r=e.y),e.x>n&&(n=e.x),e.y>i&&(i=e.y)}),{x:t,y:r,width:n-t,height:i-r}}function z(e,t,n){return e.forEach(function(e){e.boundingBox=U([e.a,e.b,e.c])}),e.filter(function(e){return e.boundingBox.width>0&&e.boundingBox.height>0})}function W(t,n,r){var i=e(t.x,1,n.width-2),s=e(t.y,1,n.height-2),o=(i|0)+(s|0)*n.width<<2;o>=n.data.length&&(o=n.data.length-5);var u=n.data[o+3]/255;return r&&u===0?r:{r:n.data[o],g:n.data[o+1],b:n.data[o+2],a:u}}function X(e){return{x:(e.a.x+e.b.x+e.c.x)*.33333,y:(e.a.y+e.b.y+e.c.y)*.33333}}function V(e){return e.a===0}function $(e){if(typeof e=="string"){var t=[0,0,0,0];return e[0]==="#"&&(e.length<7&&(e="#"+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]+(e.length>4?e[4]+e[4]:"")),t=[parseInt(e.substr(1,2),16),parseInt(e.substr(3,2),16),parseInt(e.substr(5,2),16),e.length>7?parseInt(e.substr(7,2),16)/255:1]),e.indexOf("rgb")===0&&(e.includes("rgba")||(e+=",1"),t=e.match(/[\.\d]+/g).map(function(e){return+e})),t}return}function J(e){var t=$(e);if(t){var n=t[0],r=t[1],i=t[2],s=t[3];return{r:n,g:r,b:i,a:s}}return}function K(e,t,n){var r=n.fill,i=n.stroke,s=n.strokeWidth,o=n.lineJoin,u=n.transparentColor,a=r?J(r):!1,f=i?J(i):!1,l=function(e,t){var n=V(e)&&u,r=n?u:e;return t&&!n?t:r};return e.forEach(function(e){var n=W(X(e),t);r&&(e.fill=l(n,a)),i&&(e.strokeColor=l(n,f),e.strokeWidth=s,e.lineJoin=o)}),e}function Q(e){var t=[e.r,e.g,e.b].map(function(e){return e/=255,e<=.03928?e/12.92:Math.pow((e+.055)/1.055,2.4)});return t[0]*.2126+t[1]*.7152+t[2]*.0722}function G(e,t){var n=t.x-e.x,r=t.y-e.y;return Math.sqrt(n*n+r*r)}function Y(e,t,n){return e.forEach(function(e){var r={};"abc".split("").forEach(function(i){var s=W(e[i],t,n.transparentColor);r[i]={key:i,color:s,x:e[i].x,y:e[i].y},r[i].luminance=Q(r[i].color);var o="abc".replace(i,"").split("");r[i].median={x:(e[o[0]].x+e[o[1]].x)/2,y:(e[o[0]].y+e[o[1]].y)/2},r[i].medianColor=W(r[i].median,t,n.transparentColor),r[i].medianLuminance=Q(r[i].medianColor)});var i=[r.a,r.b,r.c].sort(function(e,t){return Math.abs(e.luminance-e.medianLuminance)-Math.abs(t.luminance-t.medianLuminance)}),s=i[0],o=i[0],u=s.median,a=[o],f=G(o,u);for(var l=1,c=n.gradientStops-2;l<c;l++){var h=l*(f/n.gradientStops),p=h/f,d={x:o.x+p*(u.x-o.x),y:o.y+p*(u.y-o.y)};a.push(d)}a.push(u),e.gradient={x1:s.x,y1:s.y,x2:s.median.x,y2:s.median.y,colors:a.map(function(e){return W(e,t,n.transparentColor)})},n.stroke&&(e.strokeWidth=n.strokeWidth,e.lineJoin=n.lineJoin),r=null}),e}function Z(e,t){return e.filter(function(e){var n=W(X(e),t);return!V(n)})}function et(e,t){if(M(e)){var n={width:e.width,height:e.height},r=_(e),i=_(e),s=j(r,0,0,n.width,n.height,t.blur),o=F(s),u=A(o).toImageData(),a=I(u,t.threshold),f=R(a,t.vertexCount,t.accuracy,n.width,n.height),l=L(f);return l=z(l),t.transparentColor||(l=Z(l,i)),t.fill===!0&&t.gradients===!0?l=Y(l,i,t):l=K(l,i,t),l}throw new Error("Can't work with the imageData provided. It seems to be corrupt.")}function nt(e){function c(){return e}function h(){var e=v({},o);return i||v(e,u),e}function p(){var e=v({},o);return s||v(e,l),e}function d(e){return O(f,e)}function m(e){return O(f,e,!0)}function g(e){return O(function(e){return e},e)}function w(e){return O(function(e){return e},e,!0)}function E(e){return M(function(e){return e},e)}function x(e){return M(function(e){return e},e,!0)}function T(e){return M(b,e)}function N(e){return M(b,e,!0)}function C(e){return M(y,e)}function k(e){return M(y,e,!0)}function L(e){return M(S,e)}function A(e){return M(S,e,!0)}function O(e,n,r){return t=!!r,i=function(){return t?e(n):new Promise(function(t,r){try{var i=e(n);t(i)}catch(s){r(s)}})},_()?D():p()}function M(e,t,r){return n=!!r,s=function(r,i){return n?e(r,i,t):new Promise(function(n,s){try{var o=e(r,i,t);n(o)}catch(u){s(u)}})},_()?D():h()}function _(){return i&&s}function D(){if(t&&n){var r=i(e),o=et(r,e),u=s(o,r);return u}return new Promise(function(t,n){var r;P().then(function(t){return r=t,H(r,e)},n).then(function(e){return B(e,r)},n).then(function(e){t(e)},n)})}function P(e){return new Promise(function(n,r){if(t)try{var s=i(e);n(s)}catch(o){r(o)}else i(e).then(n,r)})}function H(e,t){return new Promise(function(n,i){r.addEventListener("message",function(e){if(e.data&&e.data.polygonJSONStr){var t=JSON.parse(e.data.polygonJSONStr);n(t)}else e.data&&e.data.err?i(e.data.err):i(e)}),r.postMessage({params:t,imageData:e,imageDataWidth:e.width,imageDataHeight:e.height})})}function B(e,t){return new Promise(function(r,i){if(n)try{var o=s(e,t);r(o)}catch(u){i(u)}else s(e,t).then(r,i)})}e=a(e);var t=!1,n=!1,r=new Worker(URL.createObjectURL(new Blob(["var commonjsGlobal = typeof window !== 'undefined' ? window : typeof global !== 'undefined' ? global : typeof self !== 'undefined' ? self : {};\n\nfunction createCommonjsModule(fn, module) {\n	return module = { exports: {} }, fn(module, module.exports), module.exports;\n}\n\nvar delaunay = createCommonjsModule(function (module) {\nfunction Triangle(a, b, c) {\n  this.a = a;\n  this.b = b;\n  this.c = c;\n\n  var A = b.x - a.x,\n      B = b.y - a.y,\n      C = c.x - a.x,\n      D = c.y - a.y,\n      E = A * (a.x + b.x) + B * (a.y + b.y),\n      F = C * (a.x + c.x) + D * (a.y + c.y),\n      G = 2 * (A * (c.y - b.y) - B * (c.x - b.x)),\n      minx, miny, dx, dy;\n\n  /* If the points of the triangle are collinear, then just find the\n   * extremes and use the midpoint as the center of the circumcircle. */\n  if(Math.abs(G) < 0.000001) {\n    minx = Math.min(a.x, b.x, c.x);\n    miny = Math.min(a.y, b.y, c.y);\n    dx   = (Math.max(a.x, b.x, c.x) - minx) * 0.5;\n    dy   = (Math.max(a.y, b.y, c.y) - miny) * 0.5;\n\n    this.x = minx + dx;\n    this.y = miny + dy;\n    this.r = dx * dx + dy * dy;\n  }\n\n  else {\n    this.x = (D*E - B*F) / G;\n    this.y = (A*F - C*E) / G;\n    dx = this.x - a.x;\n    dy = this.y - a.y;\n    this.r = dx * dx + dy * dy;\n  }\n}\n\nTriangle.prototype.draw = function(ctx) {\n  ctx.beginPath();\n  ctx.moveTo(this.a.x, this.a.y);\n  ctx.lineTo(this.b.x, this.b.y);\n  ctx.lineTo(this.c.x, this.c.y);\n  ctx.closePath();\n  ctx.stroke();\n};\n\nfunction byX(a, b) {\n  return b.x - a.x\n}\n\nfunction dedup(edges) {\n  var j = edges.length,\n      a, b, i, m, n;\n\n  outer: while(j) {\n    b = edges[--j];\n    a = edges[--j];\n    i = j;\n    while(i) {\n      n = edges[--i];\n      m = edges[--i];\n      if((a === m && b === n) || (a === n && b === m)) {\n        edges.splice(j, 2);\n        edges.splice(i, 2);\n        j -= 2;\n        continue outer\n      }\n    }\n  }\n}\n\nfunction triangulate(vertices) {\n  /* Bail if there aren't enough vertices to form any triangles. */\n  if(vertices.length < 3)\n    { return [] }\n\n  /* Ensure the vertex array is in order of descending X coordinate\n   * (which is needed to ensure a subquadratic runtime), and then find\n   * the bounding box around the points. */\n  vertices.sort(byX);\n\n  var i    = vertices.length - 1,\n      xmin = vertices[i].x,\n      xmax = vertices[0].x,\n      ymin = vertices[i].y,\n      ymax = ymin;\n\n  while(i--) {\n    if(vertices[i].y < ymin) { ymin = vertices[i].y; }\n    if(vertices[i].y > ymax) { ymax = vertices[i].y; }\n  }\n\n  /* Find a supertriangle, which is a triangle that surrounds all the\n   * vertices. This is used like something of a sentinel value to remove\n   * cases in the main algorithm, and is removed before we return any\n   * results.\n   *\n   * Once found, put it in the \"open\" list. (The \"open\" list is for\n   * triangles who may still need to be considered; the \"closed\" list is\n   * for triangles which do not.) */\n  var dx     = xmax - xmin,\n      dy     = ymax - ymin,\n      dmax   = (dx > dy) ? dx : dy,\n      xmid   = (xmax + xmin) * 0.5,\n      ymid   = (ymax + ymin) * 0.5,\n      open   = [\n        new Triangle(\n          {x: xmid - 20 * dmax, y: ymid -      dmax, __sentinel: true},\n          {x: xmid            , y: ymid + 20 * dmax, __sentinel: true},\n          {x: xmid + 20 * dmax, y: ymid -      dmax, __sentinel: true}\n        )\n      ],\n      closed = [],\n      edges = [],\n      j, a, b;\n\n  /* Incrementally add each vertex to the mesh. */\n  i = vertices.length;\n  while(i--) {\n    /* For each open triangle, check to see if the current point is\n     * inside it's circumcircle. If it is, remove the triangle and add\n     * it's edges to an edge list. */\n    edges.length = 0;\n    j = open.length;\n    while(j--) {\n      /* If this point is to the right of this triangle's circumcircle,\n       * then this triangle should never get checked again. Remove it\n       * from the open list, add it to the closed list, and skip. */\n      dx = vertices[i].x - open[j].x;\n      if(dx > 0 && dx * dx > open[j].r) {\n        closed.push(open[j]);\n        open.splice(j, 1);\n        continue\n      }\n\n      /* If not, skip this triangle. */\n      dy = vertices[i].y - open[j].y;\n      if(dx * dx + dy * dy > open[j].r)\n        { continue }\n\n      /* Remove the triangle and add it's edges to the edge list. */\n      edges.push(\n        open[j].a, open[j].b,\n        open[j].b, open[j].c,\n        open[j].c, open[j].a\n      );\n      open.splice(j, 1);\n    }\n\n    /* Remove any doubled edges. */\n    dedup(edges);\n\n    /* Add a new triangle for each edge. */\n    j = edges.length;\n    while(j) {\n      b = edges[--j];\n      a = edges[--j];\n      open.push(new Triangle(a, b, vertices[i]));\n    }\n  }\n\n  /* Copy any remaining open triangles to the closed list, and then\n   * remove any triangles that share a vertex with the supertriangle. */\n  Array.prototype.push.apply(closed, open);\n\n  i = closed.length;\n  while(i--)\n    { if(closed[i].a.__sentinel ||\n       closed[i].b.__sentinel ||\n       closed[i].c.__sentinel)\n      { closed.splice(i, 1); } }\n\n  /* Yay, we're done! */\n  return closed\n}\n\n{\n    module.exports = {\n        Triangle: Triangle,\n        triangulate: triangulate\n    };\n}\n});\nvar delaunay_1 = delaunay.Triangle;\nvar delaunay_2 = delaunay.triangulate;\n\nvar sobel = createCommonjsModule(function (module, exports) {\n(function(root) {\n\n  function Sobel(imageData) {\n    if (!(this instanceof Sobel)) {\n      return new Sobel(imageData);\n    }\n\n    var width = imageData.width;\n    var height = imageData.height;\n\n    var kernelX = [\n      [-1,0,1],\n      [-2,0,2],\n      [-1,0,1]\n    ];\n\n    var kernelY = [\n      [-1,-2,-1],\n      [0,0,0],\n      [1,2,1]\n    ];\n\n    var sobelData = [];\n    var grayscaleData = [];\n\n    function bindPixelAt(data) {\n      return function(x, y, i) {\n        i = i || 0;\n        return data[((width * y) + x) * 4 + i];\n      };\n    }\n\n    var data = imageData.data;\n    var pixelAt = bindPixelAt(data);\n    var x, y;\n\n    for (y = 0; y < height; y++) {\n      for (x = 0; x < width; x++) {\n        var r = pixelAt(x, y, 0);\n        var g = pixelAt(x, y, 1);\n        var b = pixelAt(x, y, 2);\n\n        var avg = (r + g + b) / 3;\n        grayscaleData.push(avg, avg, avg, 255);\n      }\n    }\n\n    pixelAt = bindPixelAt(grayscaleData);\n\n    for (y = 0; y < height; y++) {\n      for (x = 0; x < width; x++) {\n        var pixelX = (\n            (kernelX[0][0] * pixelAt(x - 1, y - 1)) +\n            (kernelX[0][1] * pixelAt(x, y - 1)) +\n            (kernelX[0][2] * pixelAt(x + 1, y - 1)) +\n            (kernelX[1][0] * pixelAt(x - 1, y)) +\n            (kernelX[1][1] * pixelAt(x, y)) +\n            (kernelX[1][2] * pixelAt(x + 1, y)) +\n            (kernelX[2][0] * pixelAt(x - 1, y + 1)) +\n            (kernelX[2][1] * pixelAt(x, y + 1)) +\n            (kernelX[2][2] * pixelAt(x + 1, y + 1))\n        );\n\n        var pixelY = (\n          (kernelY[0][0] * pixelAt(x - 1, y - 1)) +\n          (kernelY[0][1] * pixelAt(x, y - 1)) +\n          (kernelY[0][2] * pixelAt(x + 1, y - 1)) +\n          (kernelY[1][0] * pixelAt(x - 1, y)) +\n          (kernelY[1][1] * pixelAt(x, y)) +\n          (kernelY[1][2] * pixelAt(x + 1, y)) +\n          (kernelY[2][0] * pixelAt(x - 1, y + 1)) +\n          (kernelY[2][1] * pixelAt(x, y + 1)) +\n          (kernelY[2][2] * pixelAt(x + 1, y + 1))\n        );\n\n        var magnitude = Math.sqrt((pixelX * pixelX) + (pixelY * pixelY))>>>0;\n\n        sobelData.push(magnitude, magnitude, magnitude, 255);\n      }\n    }\n\n    var clampedArray = sobelData;\n\n    if (typeof Uint8ClampedArray === 'function') {\n      clampedArray = new Uint8ClampedArray(sobelData);\n    }\n\n    clampedArray.toImageData = function() {\n      return Sobel.toImageData(clampedArray, width, height);\n    };\n\n    return clampedArray;\n  }\n\n  Sobel.toImageData = function toImageData(data, width, height) {\n    if (typeof ImageData === 'function' && Object.prototype.toString.call(data) === '[object Uint16Array]') {\n      return new ImageData(data, width, height);\n    } else {\n      if (typeof window === 'object' && typeof window.document === 'object') {\n        var canvas = document.createElement('canvas');\n\n        if (typeof canvas.getContext === 'function') {\n          var context = canvas.getContext('2d');\n          var imageData = context.createImageData(width, height);\n          imageData.data.set(data);\n          return imageData;\n        } else {\n          return new FakeImageData(data, width, height);\n        }\n      } else {\n        return new FakeImageData(data, width, height);\n      }\n    }\n  };\n\n  function FakeImageData(data, width, height) {\n    return {\n      width: width,\n      height: height,\n      data: data\n    };\n  }\n\n  {\n    if (module.exports) {\n      exports = module.exports = Sobel;\n    }\n    exports.Sobel = Sobel;\n  }\n\n})(commonjsGlobal);\n});\nvar sobel_1 = sobel.Sobel;\n\nfunction isImageData (imageData) {\n	return (\n		imageData && \n		typeof imageData.width === 'number' &&\n		typeof imageData.height === 'number' &&\n		imageData.data &&\n		typeof imageData.data.length === 'number' &&\n		typeof imageData.data === 'object'\n	);\n}\n\nvar Canvas = function Canvas ( width, height ) {\n	if ( width === void 0 ) width = 300;\n	if ( height === void 0 ) height = 150;\n\n	if ( typeof window === 'undefined' ) {\n		this.canvasEl = { width: width, height: height };\n		this.ctx = null;\n	} else {\n		this.canvasEl = document.createElement( 'canvas' );\n		this.canvasEl.width = width;\n		this.canvasEl.height = height;\n		this.ctx = this.canvasEl.getContext( '2d' );\n	} \n};\n\nvar prototypeAccessors = { width: { configurable: true },height: { configurable: true } };\n\nCanvas.prototype.getContext = function getContext () {\n	return this.ctx;\n};\n\nCanvas.prototype.toDataURL = function toDataURL ( type, encoderOptions, cb ) {\n	if ( typeof cb === 'function' ) {\n		cb( this.canvasEl.toDataURL( type, encoderOptions ) );\n	} else {\n		return this.canvasEl.toDataURL( type, encoderOptions );\n	}\n};\n	\nprototypeAccessors.width.get = function () {\n	return this.canvasEl.width;\n};\n	\nprototypeAccessors.width.set = function ( newWidth ) {\n	this.canvasEl.width = newWidth;\n};\n\nprototypeAccessors.height.get = function () {\n	return this.canvasEl.height;\n};\n\nprototypeAccessors.height.set = function ( newHeight ) {\n	this.canvasEl.height = newHeight;\n};\n\nObject.defineProperties( Canvas.prototype, prototypeAccessors );\n\nif ( typeof window !== 'undefined' ) {\n	Canvas.Image = Image;\n}\n\n// import Canvas from 'canvas';\n\nfunction copyImageData (imageData) {\n	if ( isImageData ( imageData ) ) {\n		if ( typeof Uint8ClampedArray === 'undefined' ) {\n			if ( typeof window === 'undefined' ) {\n				throw new Error( \"Can't copy imageData in webworker without Uint8ClampedArray support.\" );\n				return imageData;\n			} else {\n				return copyImageDataWithCanvas( imageData );\n			}\n		} else {\n			var clampedArray = new Uint8ClampedArray( imageData.data );\n\n			if ( typeof ImageData === 'undefined' ) {\n				// http://stackoverflow.com/a/15238036/229189\n				return {\n					width: imageData.width,\n					height: imageData.height,\n					data: clampedArray\n				};\n			} else {\n				// http://stackoverflow.com/a/15908922/229189#comment57192591_15908922\n				var result;\n\n				try {\n					result = new ImageData( clampedArray, imageData.width, imageData.height );\n				} catch ( err ) {\n					if ( typeof window === 'undefined' ) {\n						throw new Error( \"Can't copy imageData in webworker without proper ImageData() support.\" );\n						result = imageData;\n					} else {\n						result = copyImageDataWithCanvas( imageData );\n					}\n				}\n\n				return result;\n			}\n		}\n	} else {\n		throw new Error( 'Given imageData object is not useable.' );\n		return;\n	}\n}\n\n// http://stackoverflow.com/a/11918126/229189\nfunction copyImageDataWithCanvas ( imageData ) {\n	var canvas = new Canvas( imageData.width, imageData.height );\n	var ctx = canvas.getContext( '2d' );\n\n	ctx.putImageData( imageData, 0, 0 );\n				\n	return ctx.getImageData( 0, 0, imageData.width, imageData.height );\n}\n\n/*\n    StackBlur - a fast almost Gaussian Blur For Canvas\n\n    Version:     0.5\n    Author:        Mario Klingemann\n    Contact:     mario@quasimondo.com\n    Website:    http://www.quasimondo.com/StackBlurForCanvas\n    Twitter:    @quasimondo\n\n    In case you find this class useful - especially in commercial projects -\n    I am not totally unhappy for a small donation to my PayPal account\n    mario@quasimondo.de\n\n    Or support me on flattr:\n    https://flattr.com/thing/72791/StackBlur-a-fast-almost-Gaussian-Blur-Effect-for-CanvasJavascript\n\n    Copyright (c) 2010 Mario Klingemann\n\n    Permission is hereby granted, free of charge, to any person\n    obtaining a copy of this software and associated documentation\n    files (the \"Software\"), to deal in the Software without\n    restriction, including without limitation the rights to use,\n    copy, modify, merge, publish, distribute, sublicense, and/or sell\n    copies of the Software, and to permit persons to whom the\n    Software is furnished to do so, subject to the following\n    conditions:\n\n    The above copyright notice and this permission notice shall be\n    included in all copies or substantial portions of the Software.\n\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\n    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\n    OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\n    HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\n    WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\n    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\n    OTHER DEALINGS IN THE SOFTWARE.\n    */\n\nvar mul_table = [\n    512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,\n    454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,\n    482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,\n    437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,\n    497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,\n    320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,\n    446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,\n    329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,\n    505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,\n    399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,\n    324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,\n    268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,\n    451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,\n    385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,\n    332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,\n    289,287,285,282,280,278,275,273,271,269,267,265,263,261,259];\n\n\nvar shg_table = [\n    9, 11, 12, 13, 13, 14, 14, 15, 15, 15, 15, 16, 16, 16, 16, 17,\n    17, 17, 17, 17, 17, 17, 18, 18, 18, 18, 18, 18, 18, 18, 18, 19,\n    19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 20, 20, 20,\n    20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 21,\n    21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21,\n    21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 22, 22, 22, 22, 22, 22,\n    22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22,\n    22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 23,\n    23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23,\n    23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23,\n    23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23,\n    23, 23, 23, 23, 23, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,\n    24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,\n    24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,\n    24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,\n    24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24 ];\n\nfunction BlurStack () {\n	this.r = 0;\n	this.g = 0;\n	this.b = 0;\n	this.a = 0;\n	this.next = null;\n}\n\nfunction stackblur ( imageData, top_x, top_y, width, height, radius ) {\n	var pixels = imageData.data;\n\n	var x, y, i, p, yp, yi, yw, r_sum, g_sum, b_sum, a_sum,\n		r_out_sum, g_out_sum, b_out_sum, a_out_sum,\n		r_in_sum, g_in_sum, b_in_sum, a_in_sum,\n		pr, pg, pb, pa, rbs;\n\n	var div = radius + radius + 1;\n	var widthMinus1  = width - 1;\n	var heightMinus1 = height - 1;\n	var radiusPlus1  = radius + 1;\n	var sumFactor = radiusPlus1 * ( radiusPlus1 + 1 ) / 2;\n\n	var stackStart = new BlurStack();\n	var stack = stackStart;\n	\n	for ( i = 1; i < div; i++ ) {\n		stack = stack.next = new BlurStack();\n		if (i == radiusPlus1) { var stackEnd = stack; }\n	}\n	stack.next = stackStart;\n	\n	var stackIn = null;\n	var stackOut = null;\n\n	yw = yi = 0;\n\n	var mul_sum = mul_table[radius];\n	var shg_sum = shg_table[radius];\n\n	for ( y = 0; y < height; y++ ) {\n		r_in_sum = g_in_sum = b_in_sum = a_in_sum = r_sum = g_sum = b_sum = a_sum = 0;\n\n		r_out_sum = radiusPlus1 * ( pr = pixels[yi] );\n		g_out_sum = radiusPlus1 * ( pg = pixels[yi+1] );\n		b_out_sum = radiusPlus1 * ( pb = pixels[yi+2] );\n		a_out_sum = radiusPlus1 * ( pa = pixels[yi+3] );\n\n		r_sum += sumFactor * pr;\n		g_sum += sumFactor * pg;\n		b_sum += sumFactor * pb;\n		a_sum += sumFactor * pa;\n\n		stack = stackStart;\n\n		for ( i = 0; i < radiusPlus1; i++ ) {\n			stack.r = pr;\n			stack.g = pg;\n			stack.b = pb;\n			stack.a = pa;\n			stack = stack.next;\n		}\n\n		for ( i = 1; i < radiusPlus1; i++ ) {\n			p = yi + ( ( widthMinus1 < i ? widthMinus1 : i ) << 2 );\n			r_sum += ( stack.r = ( pr = pixels[p] ) ) * ( rbs = radiusPlus1 - i );\n			g_sum += ( stack.g = ( pg = pixels[p+1] ) ) * rbs;\n			b_sum += ( stack.b = ( pb = pixels[p+2] ) ) * rbs;\n			a_sum += ( stack.a = ( pa = pixels[p+3] ) ) * rbs;\n\n			r_in_sum += pr;\n			g_in_sum += pg;\n			b_in_sum += pb;\n			a_in_sum += pa;\n\n			stack = stack.next;\n		}\n\n\n		stackIn = stackStart;\n		stackOut = stackEnd;\n\n		for (x = 0; x < width; x++) {\n			pixels[yi+3] = pa = (a_sum * mul_sum) >> shg_sum;\n			\n			if (pa != 0) {\n				pa = 255 / pa;\n				pixels[yi]   = ( ( r_sum * mul_sum ) >> shg_sum ) * pa;\n				pixels[yi+1] = ( ( g_sum * mul_sum ) >> shg_sum ) * pa;\n				pixels[yi+2] = ( ( b_sum * mul_sum ) >> shg_sum ) * pa;\n			} else {\n				pixels[yi] = pixels[yi+1] = pixels[yi+2] = 0;\n			}\n\n			r_sum -= r_out_sum;\n			g_sum -= g_out_sum;\n			b_sum -= b_out_sum;\n			a_sum -= a_out_sum;\n\n			r_out_sum -= stackIn.r;\n			g_out_sum -= stackIn.g;\n			b_out_sum -= stackIn.b;\n			a_out_sum -= stackIn.a;\n\n			p =  ( yw + ( ( p = x + radius + 1 ) < widthMinus1 ? p : widthMinus1 ) ) << 2;\n\n			r_in_sum += ( stackIn.r = pixels[p] );\n			g_in_sum += ( stackIn.g = pixels[p+1] );\n			b_in_sum += ( stackIn.b = pixels[p+2] );\n			a_in_sum += ( stackIn.a = pixels[p+3] );\n\n			r_sum += r_in_sum;\n			g_sum += g_in_sum;\n			b_sum += b_in_sum;\n			a_sum += a_in_sum;\n\n			stackIn = stackIn.next;\n\n			r_out_sum += ( pr = stackOut.r );\n			g_out_sum += ( pg = stackOut.g );\n			b_out_sum += ( pb = stackOut.b );\n			a_out_sum += ( pa = stackOut.a );\n\n			r_in_sum -= pr;\n			g_in_sum -= pg;\n			b_in_sum -= pb;\n			a_in_sum -= pa;\n\n			stackOut = stackOut.next;\n\n			yi += 4;\n		}\n		yw += width;\n	}\n\n\n	for ( x = 0; x < width; x++ ) {\n		g_in_sum = b_in_sum = a_in_sum = r_in_sum = g_sum = b_sum = a_sum = r_sum = 0;\n\n		yi = x << 2;\n		r_out_sum = radiusPlus1 * ( pr = pixels[yi] );\n		g_out_sum = radiusPlus1 * ( pg = pixels[yi+1] );\n		b_out_sum = radiusPlus1 * ( pb = pixels[yi+2] );\n		a_out_sum = radiusPlus1 * ( pa = pixels[yi+3] );\n\n		r_sum += sumFactor * pr;\n		g_sum += sumFactor * pg;\n		b_sum += sumFactor * pb;\n		a_sum += sumFactor * pa;\n\n		stack = stackStart;\n\n		for ( i = 0; i < radiusPlus1; i++) {\n			stack.r = pr;\n			stack.g = pg;\n			stack.b = pb;\n			stack.a = pa;\n			stack = stack.next;\n		}\n\n		yp = width;\n\n		for ( i = 1; i <= radius; i++ ) {\n			yi = ( yp + x ) << 2;\n\n			r_sum += ( stack.r = ( pr = pixels[yi] ) ) * (rbs = radiusPlus1 - i);\n			g_sum += ( stack.g = ( pg = pixels[yi+1] ) ) * rbs;\n			b_sum += ( stack.b = ( pb = pixels[yi+2] ) ) * rbs;\n			a_sum += ( stack.a = ( pa = pixels[yi+3] ) ) * rbs;\n\n			r_in_sum += pr;\n			g_in_sum += pg;\n			b_in_sum += pb;\n			a_in_sum += pa;\n\n			stack = stack.next;\n\n			if ( i < heightMinus1 ) {\n				yp += width;\n			}\n		}\n\n		yi = x;\n		stackIn = stackStart;\n		stackOut = stackEnd;\n\n		for ( y = 0; y < height; y++ ) {\n			p = yi << 2;\n			pixels[p+3] = pa = ( a_sum * mul_sum ) >> shg_sum;\n			\n			if ( pa > 0 ) {\n				pa = 255 / pa;\n				pixels[p]   = ( ( r_sum * mul_sum ) >> shg_sum) * pa;\n				pixels[p+1] = ( ( g_sum * mul_sum ) >> shg_sum) * pa;\n				pixels[p+2] = ( ( b_sum * mul_sum ) >> shg_sum) * pa;\n			} else {\n				pixels[p] = pixels[p+1] = pixels[p+2] = 0;\n			}\n\n			r_sum -= r_out_sum;\n			g_sum -= g_out_sum;\n			b_sum -= b_out_sum;\n			a_sum -= a_out_sum;\n\n			r_out_sum -= stackIn.r;\n			g_out_sum -= stackIn.g;\n			b_out_sum -= stackIn.b;\n			a_out_sum -= stackIn.a;\n\n			p = ( x + ( ( ( p = y + radiusPlus1 ) < heightMinus1 ? p : heightMinus1 ) * width ) ) << 2;\n\n			r_sum += ( r_in_sum += ( stackIn.r = pixels[p] ) );\n			g_sum += ( g_in_sum += ( stackIn.g = pixels[p+1] ) );\n			b_sum += ( b_in_sum += ( stackIn.b = pixels[p+2] ) );\n			a_sum += ( a_in_sum += ( stackIn.a = pixels[p+3] ) );\n\n			stackIn = stackIn.next;\n\n			r_out_sum += ( pr = stackOut.r );\n			g_out_sum += ( pg = stackOut.g );\n			b_out_sum += ( pb = stackOut.b );\n			a_out_sum += ( pa = stackOut.a );\n\n			r_in_sum -= pr;\n			g_in_sum -= pg;\n			b_in_sum -= pb;\n			a_in_sum -= pa;\n\n			stackOut = stackOut.next;\n\n			yi += width;\n		}\n	}\n\n	return imageData;\n}\n\nfunction greyscale (imageData) {\n	var len = imageData.data.length;\n	var brightness;\n\n	for ( var i = 0; i < len; i += 4 ) {\n		brightness = 0.34 * imageData.data[i] + 0.5 * imageData.data[i + 1] + 0.16 * imageData.data[i + 2];\n\n		imageData.data[i] = brightness;\n		imageData.data[i + 1] = brightness;\n		imageData.data[i + 2] = brightness;\n	}\n		\n	return imageData;\n}\n\n// most parts taken from http://jsdo.it/akm2/xoYx\n// (starting line 293++)\nfunction getEdgePoints ( imageData, threshold ) {\n	// only check every 2nd pixel in imageData to save some time.\n	var multiplier = 2;\n	var width = imageData.width;\n	var height = imageData.height;\n	var data = imageData.data;\n	var points = [ ];\n	var x, y, row, col, sx, sy, step, sum, total;\n\n	for ( y = 0; y < height; y += multiplier ) {\n		for ( x = 0; x < width; x += multiplier ) {\n			sum = total = 0;\n\n			for ( row = -1; row <= 1; row++ ) {\n				sy = y + row;\n				step = sy * width;\n\n				if ( sy >= 0 && sy < height ) {\n					for ( col = -1; col <= 1; col++ ) {\n						sx = x + col;\n\n						if ( sx >= 0 && sx < width ) {\n							sum += data[( sx + step ) << 2];\n							total++;\n						}\n					}\n				}\n			}\n\n			if ( total ) {\n				sum /= total;\n			}\n\n			if ( sum > threshold ) {\n				points.push( { x: x, y: y } );\n			}\n		}\n	}\n\n	return points;\n}\n\nfunction clamp ( value, min, max ) {\n	return value < min ? min : value > max ? max : value;\n}\n\nfunction addVertex ( x, y, hash ) {\n	var resultKey = x + '|' + y;\n\n	if ( ! hash[resultKey] ) {\n		hash[resultKey] = { x: x, y: y };\n	}\n\n	resultKey = null;\n}\n\nfunction getVerticesFromPoints ( points, maxPointCount, accuracy, width, height ) {\n	// using hash for all points to make sure we have a set of unique vertices.\n	var resultHash = { };\n\n	// use 25% of max point count to create a background grid.\n	// this avoids having too many \"big\" triangles in areas of the image with low contrast \n	// next to very small ones in areas with high contrast\n	// for every other row, start the x value at > 0, so the grid doesn't look too regular\n	var gridPointCount = Math.max( ~~( maxPointCount * ( 1 - accuracy ) ), 5 );\n\n	// http://stackoverflow.com/a/4107092/229189\n	var gridColumns = Math.round( Math.sqrt( gridPointCount ) );\n	var gridRows = Math.round( Math.ceil( gridPointCount / gridColumns ) );\n	\n	var xIncrement = ~~( width / gridColumns );\n	var yIncrement = ~~( height / gridRows );\n\n	var rowIndex = 0;\n	var startX = 0;\n\n	var x = 0;\n	var y = 0;\n\n	for ( y = 0; y < height; y+= yIncrement ) {\n		rowIndex++;\n\n		startX = rowIndex % 2 === 0 ? ~~( xIncrement / 2 ) : 0; \n\n		for ( x = startX; x < width; x += xIncrement ) {\n			if ( x < width && y < height ) {\n				// \"distorting\" the grid a little bit so that the\n				// background vertices don't appear to be on a straight line (which looks boring)\n				addVertex(\n					~~( x + ( Math.cos( y ) * ( yIncrement ) ) ),\n					~~( y + ( Math.sin( x ) * ( xIncrement ) ) ),\n					resultHash\n				);\n			}\n		}\n	}\n	\n	// add points in the corners\n	addVertex( 0, 0, resultHash );\n	addVertex( width - 1, 0, resultHash );\n	addVertex( width - 1, height - 1, resultHash );\n	addVertex( 0, height - 1, resultHash );\n\n	// add points from all edge points\n	var remainingPointCount = maxPointCount - Object.keys( resultHash ).length;\n	var edgePointCount = points.length;\n	var increment = ~~( edgePointCount / remainingPointCount );\n\n	if ( maxPointCount > 0 && increment > 0 ) {\n		var i = 0;\n\n		for ( i = 0; i < edgePointCount; i += increment ) {\n			addVertex( points[i].x, points[i].y, resultHash );\n		}\n	}\n\n	points = null;\n\n	return Object.keys( resultHash ).map( function (key) {\n		return resultHash[key];\n	} );\n}\n\nfunction getBoundingBox (points) {\n	var xMin = Infinity;\n	var xMax = -Infinity;\n	var yMin = Infinity;\n	var yMax = -Infinity;\n\n	points.forEach( function (p) {\n		if ( p.x < xMin ) {\n			xMin = p.x;\n		}\n\n		if ( p.y < yMin ) {\n			yMin = p.y;\n		}\n\n		if ( p.x > xMax ) {\n			xMax = p.x;\n		}\n\n		if ( p.y > yMax ) {\n			yMax = p.y;\n		}\n	} );\n\n	return {\n		x: xMin,\n		y: yMin,\n		width: xMax - xMin,\n		height: yMax - yMin\n	};\n}\n\nfunction addBoundingBoxesToPolygons ( polygons, colorData, params ) {\n	polygons.forEach( function (polygon) {\n		polygon.boundingBox = getBoundingBox( [ polygon.a, polygon.b, polygon.c ] );\n	} );\n\n	return polygons.filter( function (polygon) {\n		return polygon.boundingBox.width > 0 && polygon.boundingBox.height > 0;\n	} );\n}\n\n/**\n * Get color object by position\n * @param  {Object} pos         {x,y} object\n * @param  {Object} colorData   Image color data object\n * @param  {Object} [transparentColor] (optional) RGBA color object. Used to set specific color to transparent pixels\n * @return {Object}             RGBA color object\n */\nfunction getColorByPos ( pos, colorData, transparentColor ) {\n	var x = clamp( pos.x, 1, colorData.width - 2 );\n	var y = clamp( pos.y, 1, colorData.height - 2 );\n	var index = ( ( x | 0 ) + ( y | 0 ) * colorData.width ) << 2;\n\n	if ( index >= colorData.data.length ) {\n		index = colorData.data.length - 5;\n	}\n\n	var alpha = colorData.data[index + 3] / 255;\n\n	// Return RGBA color object\n	return ( transparentColor && alpha === 0 ) ? transparentColor : {\n		r: colorData.data[index],\n		g: colorData.data[index + 1],\n		b: colorData.data[index + 2],\n		a: alpha\n	};\n}\n\n/**\n * Get polygon's center point\n * @param  {Object} polygon Polygon object\n * @return {Object}         Point coordinates {x,y}\n */\nfunction polygonCenter (polygon) {\n	return {\n		x: ( polygon.a.x + polygon.b.x + polygon.c.x ) * 0.33333,\n		y: ( polygon.a.y + polygon.b.y + polygon.c.y ) * 0.33333\n	};\n}\n\n/**\n * Is color transparent ?\n * @param  {Object} color Color object\n * @return {Boolean}      Is transparent?\n */\nfunction isTransparent (color) {\n	return color.a === 0;\n}\n\n/*\nobject-assign\n(c) Sindre Sorhus\n@license MIT\n*/\n/* eslint-disable no-unused-vars */\nvar getOwnPropertySymbols = Object.getOwnPropertySymbols;\nvar hasOwnProperty = Object.prototype.hasOwnProperty;\nvar propIsEnumerable = Object.prototype.propertyIsEnumerable;\n\nfunction toObject(val) {\n	if (val === null || val === undefined) {\n		throw new TypeError('Object.assign cannot be called with null or undefined');\n	}\n\n	return Object(val);\n}\n\nfunction shouldUseNative() {\n	try {\n		if (!Object.assign) {\n			return false;\n		}\n\n		// Detect buggy property enumeration order in older V8 versions.\n\n		// https://bugs.chromium.org/p/v8/issues/detail?id=4118\n		var test1 = new String('abc');  // eslint-disable-line no-new-wrappers\n		test1[5] = 'de';\n		if (Object.getOwnPropertyNames(test1)[0] === '5') {\n			return false;\n		}\n\n		// https://bugs.chromium.org/p/v8/issues/detail?id=3056\n		var test2 = {};\n		for (var i = 0; i < 10; i++) {\n			test2['_' + String.fromCharCode(i)] = i;\n		}\n		var order2 = Object.getOwnPropertyNames(test2).map(function (n) {\n			return test2[n];\n		});\n		if (order2.join('') !== '0123456789') {\n			return false;\n		}\n\n		// https://bugs.chromium.org/p/v8/issues/detail?id=3056\n		var test3 = {};\n		'abcdefghijklmnopqrst'.split('').forEach(function (letter) {\n			test3[letter] = letter;\n		});\n		if (Object.keys(Object.assign({}, test3)).join('') !==\n				'abcdefghijklmnopqrst') {\n			return false;\n		}\n\n		return true;\n	} catch (err) {\n		// We don't expect any of the above to throw, but better to be safe.\n		return false;\n	}\n}\n\nvar objectAssign = shouldUseNative() ? Object.assign : function (target, source) {\n	var arguments$1 = arguments;\n\n	var from;\n	var to = toObject(target);\n	var symbols;\n\n	for (var s = 1; s < arguments.length; s++) {\n		from = Object(arguments$1[s]);\n\n		for (var key in from) {\n			if (hasOwnProperty.call(from, key)) {\n				to[key] = from[key];\n			}\n		}\n\n		if (getOwnPropertySymbols) {\n			symbols = getOwnPropertySymbols(from);\n			for (var i = 0; i < symbols.length; i++) {\n				if (propIsEnumerable.call(from, symbols[i])) {\n					to[symbols[i]] = from[symbols[i]];\n				}\n			}\n		}\n	}\n\n	return to;\n};\n\n// import objectAssign from 'object-assign'\n\n// https://gist.githubusercontent.com/oriadam/396a4beaaad465ca921618f2f2444d49/raw/76b0de6caffaac59f8af2b4dfa0e0b6397cf447d/colorValues.js\n// return array of [r,g,b,a] from any valid color. if failed returns undefined\nfunction strToColorArr ( color ) {\n	if ( typeof color === 'string' ) {\n		var result = [ 0, 0, 0, 0 ];\n		\n		if ( color[0] === '#' )	{\n			// convert #RGB and #RGBA to #RRGGBB and #RRGGBBAA\n			if ( color.length < 7 ) {\n				color = \"#\" + (color[1]) + (color[1]) + (color[2]) + (color[2]) + (color[3]) + (color[3]) + (color.length > 4 ? color[4] + color[4] : '');\n			}\n\n			result = [\n				parseInt(color.substr( 1, 2 ), 16),\n				parseInt(color.substr( 3, 2 ), 16),\n				parseInt(color.substr( 5, 2 ), 16),\n				color.length > 7 ? parseInt( color.substr( 7, 2 ), 16 ) / 255 : 1\n			];\n		}\n\n		if ( color.indexOf('rgb') === 0 ) {\n			// convert 'rgb(R,G,B)' to 'rgb(R,G,B)A' which looks awful but will pass the regxep below\n			if ( ! color.includes( 'rgba' ) ) {\n				color += ',1';\n			}\n\n			result = color\n				.match( /[\\.\\d]+/g )\n				.map( function (a) { return +a; } );\n		}\n		\n		return result;\n	} else {\n		return;\n	}\n\n}\n\nfunction strToColor ( str ) {\n	var color = strToColorArr( str );\n\n	if ( color ) {\n		var r = color[0];\n		var g = color[1];\n		var b = color[2];\n		var a = color[3];\n		return { r: r, g: g, b: b, a: a };\n	} else {\n		return;\n	}\n}\n\nfunction addColorToPolygons ( polygons, colorData, params ) {\n	var fill = params.fill;\n	var stroke = params.stroke;\n	var strokeWidth = params.strokeWidth;\n	var lineJoin = params.lineJoin;\n	var transparentColor = params.transparentColor;\n	var fillColor = fill ? strToColor( fill ) : false;\n	var strokeColor = stroke ? strToColor( stroke ) : false;\n\n	/**\n	 * Color override logic\n	 * @param  {Object} color    Color object\n	 * @param  {String} override Override color (fillColor/strokeColor)\n	 * @return {String}          CSS formatted color (rgba,..)\n	 */\n	var getColor = function ( color, override ) {\n		var t = ( isTransparent( color ) && transparentColor );	// Color is transparent, and transparentColor override is defined\n		var c = t ? transparentColor : color;\n		return ( override && !t ) ? override : c;		// Priority: transparentColor -> override -> supplied color\n	};\n\n	polygons.forEach( function (polygon) {\n		var color = getColorByPos( polygonCenter( polygon ), colorData );\n\n		if ( fill ) {\n			polygon.fill = getColor( color, fillColor );\n		}\n\n		if ( stroke ) {\n			polygon.strokeColor = getColor(color, strokeColor);\n			polygon.strokeWidth = strokeWidth;\n			polygon.lineJoin = lineJoin;\n		}\n	} );\n\n	return polygons;\n}\n\n//  http://stackoverflow.com/a/9733420/229189\nfunction luminance (color) {\n	var a = [ color.r, color.g, color.b ].map( function (v) {\n		v /= 255;\n		return ( v <= 0.03928 ) ? v / 12.92 : Math.pow( ( ( v + 0.055 ) / 1.055 ), 2.4 );\n	} );\n\n	return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;\n}\n\nfunction distance ( a, b ) {\n	var dx = b.x - a.x;\n	var dy = b.y - a.y;\n\n	return Math.sqrt( ( dx * dx ) + ( dy * dy ) );\n}\n\nfunction addGradientsToPolygons ( polygons, colorData, params ) {\n	polygons.forEach( function (polygon) {\n		var data = { };\n\n		'abc'.split( '' ).forEach( function (key) {\n			var color = getColorByPos( polygon[key], colorData, params.transparentColor );\n			\n			data[key] = {\n				key: key,\n				color: color,\n				x: polygon[key].x,\n				y: polygon[key].y\n			};\n\n			data[key].luminance = luminance( data[key].color );\n\n			var otherKeys = 'abc'.replace( key, '' ).split( '' );\n\n			data[key].median = {\n				x: ( polygon[otherKeys[0]].x + polygon[otherKeys[1]].x ) / 2,\n				y: ( polygon[otherKeys[0]].y + polygon[otherKeys[1]].y ) / 2\n			};\n\n			data[key].medianColor = getColorByPos( data[key].median, colorData, params.transparentColor );\n			data[key].medianLuminance = luminance( data[key].medianColor );\n		} );\n\n		// sort by axis of most difference in luminance\n		var pointsByDeltaInLuminance = [ data.a, data.b, data.c ].sort( function ( u, v ) {\n			return Math.abs( u.luminance - u.medianLuminance ) - Math.abs( v.luminance - v.medianLuminance );\n		} );\n\n		var pointWithMostDeltaInLuminance = pointsByDeltaInLuminance[0];\n		var startPoint = pointsByDeltaInLuminance[0];\n		var endPoint = pointWithMostDeltaInLuminance.median;\n\n		var gradienStopPositions = [ startPoint ];\n\n		var startToEndDistance = distance( startPoint, endPoint );\n\n		for ( var i = 1, len = params.gradientStops - 2; i < len; i++ ) {\n			var pointDistance = i * ( startToEndDistance / params.gradientStops );\n			var pointPercent = pointDistance / startToEndDistance;\n			\n			var point = {\n				x: startPoint.x + pointPercent * ( endPoint.x - startPoint.x ), \n				y: startPoint.y + pointPercent * ( endPoint.y - startPoint.y )\n			};\n\n			gradienStopPositions.push( point );\n		}\n\n		gradienStopPositions.push( endPoint );\n\n		polygon.gradient = {\n			x1: pointWithMostDeltaInLuminance.x,\n			y1: pointWithMostDeltaInLuminance.y,\n			x2: pointWithMostDeltaInLuminance.median.x,\n			y2: pointWithMostDeltaInLuminance.median.y,\n			colors: gradienStopPositions.map( function (pos) {\n				return getColorByPos( pos, colorData, params.transparentColor );\n			} )\n		};\n\n		if ( params.stroke ) {\n			polygon.strokeWidth = params.strokeWidth;\n			polygon.lineJoin = params.lineJoin;\n		}\n\n		data = null;\n	} );\n\n	return polygons;\n}\n\n/**\n * Filter polygons with transparent color\n * @param  {Array} polygons    Polygons array\n * @param  {Object} colorData  Color data\n * @return {Array}             Filtered polygons array\n */\nfunction filterTransparentPolygons ( polygons, colorData ) {\n	return polygons.filter( function (polygon) {\n		var color = getColorByPos( polygonCenter( polygon ), colorData );\n		return ! isTransparent( color );\n	});\n}\n\nfunction imageDataToPolygons ( imageData, params ) {\n	if ( isImageData( imageData ) ) {\n		var imageSize = { width: imageData.width, height: imageData.height };\n		var tmpImageData = copyImageData( imageData );\n		var colorImageData = copyImageData( imageData );\n		var blurredImageData = stackblur( tmpImageData, 0, 0, imageSize.width, imageSize.height, params.blur );\n		var greyscaleImageData = greyscale( blurredImageData );\n		var edgesImageData = sobel( greyscaleImageData ).toImageData();\n		var edgePoints = getEdgePoints( edgesImageData, params.threshold );\n		var edgeVertices = getVerticesFromPoints( edgePoints, params.vertexCount, params.accuracy, imageSize.width, imageSize.height );\n		var polygons = delaunay_2( edgeVertices );\n		\n		polygons = addBoundingBoxesToPolygons( polygons );\n		\n		if ( ! params.transparentColor ) {\n			polygons = filterTransparentPolygons( polygons, colorImageData );\n		}\n		\n		if ( params.fill === true && params.gradients === true ) {\n			polygons = addGradientsToPolygons( polygons, colorImageData, params );\n		} else {\n			polygons = addColorToPolygons( polygons, colorImageData, params );\n		}\n\n		return polygons;\n	} else {\n		throw new Error( \"Can't work with the imageData provided. It seems to be corrupt.\" );\n		return;\n	}\n}\n\nonmessage = function (msg) {\n	if ( msg.data.imageData && msg.data.params ) {\n		try {\n			var imageData = msg.data.imageData;\n\n			// phantomjs seems to have some memory loss so we need to make sure\n			if ( typeof imageData.width === 'undefined' && typeof msg.data.imageDataWidth === 'number' ) {\n				imageData.width = msg.data.imageDataWidth;\n			}\n\n			if ( typeof imageData.height === 'undefined' && typeof msg.data.imageDataHeight === 'number' ) {\n				imageData.height = msg.data.imageDataHeight;\n			}\n			\n			var polygons = imageDataToPolygons( msg.data.imageData, msg.data.params );\n						\n			self.postMessage( {\n				polygonJSONStr: JSON.stringify( polygons )\n			} );\n		} catch ( err ) {\n			self.postMessage( { err: err.message || err } );\n		}\n\n	} else {\n		if ( msg.data.imageData ) {\n			self.postMessage( { err: 'Parameters are missing.' } );\n		} else {\n			self.postMessage( { err: 'ImageData is missing.' } );\n		}\n	}\n	\n	self.close();\n};\n"],{type:"text/javascript"}))),i,s,o={getParams:c,getInput:h,getOutput:p},u={fromImage:d,fromImageSync:m,fromImageData:g,fromImageDataSync:w},l={toData:E,toDataSync:x,toDataURL:T,toDataURLSync:N,toImageData:C,toImageDataSync:k,toSVG:L,toSVGSync:A};return h()}var n=function(t,n){t===void 0&&(t=300),n===void 0&&(n=150),typeof window=="undefined"?(this.canvasEl={width:t,height:n},this.ctx=null):(this.canvasEl=document.createElement("canvas"),this.canvasEl.width=t,this.canvasEl.height=n,this.ctx=this.canvasEl.getContext("2d"))},r={width:{configurable:!0},height:{configurable:!0}};n.prototype.getContext=function(){return this.ctx},n.prototype.toDataURL=function(t,n,r){if(typeof r!="function")return this.canvasEl.toDataURL(t,n);r(this.canvasEl.toDataURL(t,n))},r.width.get=function(){return this.canvasEl.width},r.width.set=function(e){this.canvasEl.width=e},r.height.get=function(){return this.canvasEl.height},r.height.set=function(e){this.canvasEl.height=e},Object.defineProperties(n.prototype,r),typeof window!="undefined"&&(n.Image=Image);var o={accuracy:.7,blur:4,fill:!0,stroke:!0,strokeWidth:.5,lineJoin:"miter",vertexCount:700,threshold:50,transparentColor:!1},u=["miter","round","bevel"],l=Object.getOwnPropertySymbols,c=Object.prototype.hasOwnProperty,h=Object.prototype.propertyIsEnumerable,v=d()?Object.assign:function(e,t){var n=arguments,r,i=p(e),s;for(var o=1;o<arguments.length;o++){r=Object(n[o]);for(var u in r)c.call(r,u)&&(i[u]=r[u]);if(l){s=l(r);for(var a=0;a<s.length;a++)h.call(r,s[a])&&(i[s[a]]=r[s[a]])}}return i},x=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},C=N(function(e){function t(e,t,n){this.a=e,this.b=t,this.c=n;var r=t.x-e.x,i=t.y-e.y,s=n.x-e.x,o=n.y-e.y,u=r*(e.x+t.x)+i*(e.y+t.y),a=s*(e.x+n.x)+o*(e.y+n.y),f=2*(r*(n.y-t.y)-i*(n.x-t.x)),l,c,h,p;Math.abs(f)<1e-6?(l=Math.min(e.x,t.x,n.x),c=Math.min(e.y,t.y,n.y),h=(Math.max(e.x,t.x,n.x)-l)*.5,p=(Math.max(e.y,t.y,n.y)-c)*.5,this.x=l+h,this.y=c+p,this.r=h*h+p*p):(this.x=(o*u-i*a)/f,this.y=(r*a-s*u)/f,h=this.x-e.x,p=this.y-e.y,this.r=h*h+p*p)}function n(e,t){return t.x-e.x}function r(e){var t=e.length,n,r,i,s,o;e:while(t){r=e[--t],n=e[--t],i=t;while(i){o=e[--i],s=e[--i];if(n===s&&r===o||n===o&&r===s){e.splice(t,2),e.splice(i,2),t-=2;continue e}}}}function i(e){if(e.length<3)return[];e.sort(n);var i=e.length-1,s=e[i].x,o=e[0].x,u=e[i].y,a=u;while(i--)e[i].y<u&&(u=e[i].y),e[i].y>a&&(a=e[i].y);var f=o-s,l=a-u,c=f>l?f:l,h=(o+s)*.5,p=(a+u)*.5,d=[new t({x:h-20*c,y:p-c,__sentinel:!0},{x:h,y:p+20*c,__sentinel:!0},{x:h+20*c,y:p-c,__sentinel:!0})],v=[],m=[],g,y,b;i=e.length;while(i--){m.length=0,g=d.length;while(g--){f=e[i].x-d[g].x;if(f>0&&f*f>d[g].r){v.push(d[g]),d.splice(g,1);continue}l=e[i].y-d[g].y;if(f*f+l*l>d[g].r)continue;m.push(d[g].a,d[g].b,d[g].b,d[g].c,d[g].c,d[g].a),d.splice(g,1)}r(m),g=m.length;while(g)b=m[--g],y=m[--g],d.push(new t(y,b,e[i]))}Array.prototype.push.apply(v,d),i=v.length;while(i--)(v[i].a.__sentinel||v[i].b.__sentinel||v[i].c.__sentinel)&&v.splice(i,1);return v}t.prototype.draw=function(e){e.beginPath(),e.moveTo(this.a.x,this.a.y),e.lineTo(this.b.x,this.b.y),e.lineTo(this.c.x,this.c.y),e.closePath(),e.stroke()},e.exports={Triangle:t,triangulate:i}}),k=C.Triangle,L=C.triangulate,A=N(function(e,t){(function(n){function r(e){function a(e){return function(n,r,i){return i=i||0,e[(t*r+n)*4+i]}}if(this instanceof r){var t=e.width,n=e.height,i=[[-1,0,1],[-2,0,2],[-1,0,1]],s=[[-1,-2,-1],[0,0,0],[1,2,1]],o=[],u=[],f=e.data,l=a(f),c,h;for(h=0;h<n;h++)for(c=0;c<t;c++){var p=l(c,h,0),d=l(c,h,1),v=l(c,h,2),m=(p+d+v)/3;u.push(m,m,m,255)}l=a(u);for(h=0;h<n;h++)for(c=0;c<t;c++){var g=i[0][0]*l(c-1,h-1)+i[0][1]*l(c,h-1)+i[0][2]*l(c+1,h-1)+i[1][0]*l(c-1,h)+i[1][1]*l(c,h)+i[1][2]*l(c+1,h)+i[2][0]*l(c-1,h+1)+i[2][1]*l(c,h+1)+i[2][2]*l(c+1,h+1),y=s[0][0]*l(c-1,h-1)+s[0][1]*l(c,h-1)+s[0][2]*l(c+1,h-1)+s[1][0]*l(c-1,h)+s[1][1]*l(c,h)+s[1][2]*l(c+1,h)+s[2][0]*l(c-1,h+1)+s[2][1]*l(c,h+1)+s[2][2]*l(c+1,h+1),b=Math.sqrt(g*g+y*y)>>>0;o.push(b,b,b,255)}var w=o;return typeof Uint8ClampedArray=="function"&&(w=new Uint8ClampedArray(o)),w.toImageData=function(){return r.toImageData(w,t,n)},w}return new r(e)}function i(e,t,n){return{width:t,height:n,data:e}}r.toImageData=function(t,n,r){if(typeof ImageData=="function"&&Object.prototype.toString.call(t)==="[object Uint16Array]")return new ImageData(t,n,r);if(typeof window=="object"&&typeof window.document=="object"){var s=document.createElement("canvas");if(typeof s.getContext=="function"){var o=s.getContext("2d"),u=o.createImageData(n,r);return u.data.set(t),u}return new i(t,n,r)}return new i(t,n,r)},e.exports&&(t=e.exports=r),t.Sobel=r})(x)}),O=A.Sobel,P=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],H=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],tt=N(function(e,t){(function(t,n){e.exports=n()})(x,function(){function e(e){return typeof e=="function"||typeof e=="object"&&e!==null}function t(e){return typeof e=="function"}function a(e){o=e}function f(e){u=e}function v(){return function(){return process.nextTick(E)}}function m(){return typeof s!="undefined"?function(){s(E)}:b()}function g(){var e=0,t=new h(E),n=document.createTextNode("");return t.observe(n,{characterData:!0}),function(){n.data=e=++e%2}}function y(){var e=new MessageChannel;return e.port1.onmessage=E,function(){return e.port2.postMessage(0)}}function b(){var e=setTimeout;return function(){return e(E,1)}}function E(){for(var e=0;e<i;e+=2){var t=w[e],n=w[e+1];t(n),w[e]=undefined,w[e+1]=undefined}i=0}function S(){try{var e=T,t=e("vertx");return s=t.runOnLoop||t.runOnContext,m()}catch(n){return b()}}function C(e,t){var n=arguments,r=this,i=new this.constructor(A);i[L]===undefined&&et(i);var s=r._state;return s?function(){var e=n[s-1];u(function(){return Q(s,i,e,r._result)})}():X(r,i,e,t),i}function k(e){var t=this;if(e&&typeof e=="object"&&e.constructor===t)return e;var n=new t(A);return R(n,e),n}function A(){}function P(){return new TypeError("You cannot resolve a promise with itself")}function H(){return new TypeError("A promises callback cannot return that same promise.")}function B(e){try{return e.then}catch(t){return D.error=t,D}}function j(e,t,n,r){try{e.call(t,n,r)}catch(i){return i}}function F(e,t,n){u(function(e){var r=!1,i=j(n,t,function(n){if(r)return;r=!0,t!==n?R(e,n):z(e,n)},function(t){if(r)return;r=!0,W(e,t)},"Settle: "+(e._label||" unknown promise"));!r&&i&&(r=!0,W(e,i))},e)}function I(e,t){t._state===M?z(e,t._result):t._state===_?W(e,t._result):X(t,undefined,function(t){return R(e,t)},function(t){return W(e,t)})}function q(e,n,r){n.constructor===e.constructor&&r===C&&n.constructor.resolve===k?I(e,n):r===D?(W(e,D.error),D.error=null):r===undefined?z(e,n):t(r)?F(e,n,r):z(e,n)}function R(t,n){t===n?W(t,P()):e(n)?q(t,n,B(n)):z(t,n)}function U(e){e._onerror&&e._onerror(e._result),V(e)}function z(e,t){if(e._state!==O)return;e._result=t,e._state=M,e._subscribers.length!==0&&u(V,e)}function W(e,t){if(e._state!==O)return;e._state=_,e._result=t,u(U,e)}function X(e,t,n,r){var i=e._subscribers,s=i.length;e._onerror=null,i[s]=t,i[s+M]=n,i[s+_]=r,s===0&&e._state&&u(V,e)}function V(e){var t=e._subscribers,n=e._state;if(t.length===0)return;var r=undefined,i=undefined,s=e._result;for(var o=0;o<t.length;o+=3)r=t[o],i=t[o+n],r?Q(n,r,i,s):i(s);e._subscribers.length=0}function $(){this.error=null}function K(e,t){try{return e(t)}catch(n){return J.error=n,J}}function Q(e,n,r,i){var s=t(r),o=undefined,u=undefined,a=undefined,f=undefined;if(s){o=K(r,i),o===J?(f=!0,u=o.error,o.error=null):a=!0;if(n===o){W(n,H());return}}else o=i,a=!0;n._state===O&&(s&&a?R(n,o):f?W(n,u):e===M?z(n,o):e===_&&W(n,o))}function G(e,t){try{t(function(n){R(e,n)},function(n){W(e,n)})}catch(n){W(e,n)}}function Z(){return Y++}function et(e){e[L]=Y++,e._state=undefined,e._result=undefined,e._subscribers=[]}function tt(e,t){this._instanceConstructor=e,this.promise=new e(A),this.promise[L]||et(this.promise),r(t)?(this._input=t,this.length=t.length,this._remaining=t.length,this._result=new Array(this.length),this.length===0?z(this.promise,this._result):(this.length=this.length||0,this._enumerate(),this._remaining===0&&z(this.promise,this._result))):W(this.promise,nt())}function nt(){return new Error("Array Methods must be provided an Array")}function rt(e){return(new tt(this,e)).promise}function it(e){var t=this;return r(e)?new t(function(n,r){var i=e.length;for(var s=0;s<i;s++)t.resolve(e[s]).then(n,r)}):new t(function(e,t){return t(new TypeError("You must pass an array to race."))})}function st(e){var t=this,n=new t(A);return W(n,e),n}function ot(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function ut(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function at(e){this[L]=Z(),this._result=this._state=undefined,this._subscribers=[],A!==e&&(typeof e!="function"&&ot(),this instanceof at?G(this,e):ut())}function ft(){var e=undefined;if(typeof x!="undefined")e=x;else if(typeof self!="undefined")e=self;else try{e=Function("return this")()}catch(t){throw new Error("polyfill failed because global object is unavailable in this environment")}var n=e.Promise;if(n){var r=null;try{r=Object.prototype.toString.call(n.resolve())}catch(t){}if(r==="[object Promise]"&&!n.cast)return}e.Promise=at}var n=undefined;Array.isArray?n=Array.isArray:n=function(e){return Object.prototype.toString.call(e)==="[object Array]"};var r=n,i=0,s=undefined,o=undefined,u=function(t,n){w[i]=t,w[i+1]=n,i+=2,i===2&&(o?o(E):N())},l=typeof window!="undefined"?window:undefined,c=l||{},h=c.MutationObserver||c.WebKitMutationObserver,p=typeof self=="undefined"&&typeof process!="undefined"&&{}.toString.call(process)==="[object process]",d=typeof Uint8ClampedArray!="undefined"&&typeof importScripts!="undefined"&&typeof MessageChannel!="undefined",w=new Array(1e3),N=undefined;p?N=v():h?N=g():d?N=y():l===undefined&&typeof T=="function"?N=S():N=b();var L=Math.random().toString(36).substring(16),O=void 0,M=1,_=2,D=new $,J=new $,Y=0;return tt.prototype._enumerate=function(){var e=this.length,t=this._input;for(var n=0;this._state===O&&n<e;n++)this._eachEntry(t[n],n)},tt.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,r=n.resolve;if(r===k){var i=B(e);if(i===C&&e._state!==O)this._settledAt(e._state,t,e._result);else if(typeof i!="function")this._remaining--,this._result[t]=e;else if(n===at){var s=new n(A);q(s,e,i),this._willSettleAt(s,t)}else this._willSettleAt(new n(function(t){return t(e)}),t)}else this._willSettleAt(r(e),t)},tt.prototype._settledAt=function(e,t,n){var r=this.promise;r._state===O&&(this._remaining--,e===_?W(r,n):this._result[t]=n),this._remaining===0&&z(r,this._result)},tt.prototype._willSettleAt=function(e,t){var n=this;X(e,undefined,function(e){return n._settledAt(M,t,e)},function(e){return n._settledAt(_,t,e)})},at.all=rt,at.race=it,at.resolve=k,at.reject=st,at._setScheduler=a,at._setAsap=f,at._asap=u,at.prototype={constructor:at,then:C,"catch":function(t){return this.then(null,t)}},at.polyfill=ft,at.Promise=at,at})});return tt.polyfill(),nt}),define("src/process",["lib/triangulate-image-browser-with-polyfills"],function(e){function c(e){o=e.signals,o["image-loaded"].add(p),o["control-updated"].add(h),o["export-requested"].add(b)}function h(e){i=w(e),d()}function p(e){r||(s=e,v(s))}function d(){!r&&s&&v(s)}function v(s){r=!0,y(t,n),g(t,s,l),e(i).fromImage(s).toImageData({dpr:l}).then(function(e){m(n,e)}),r=!1}function m(e,t){e.putImageData(t,0,0)}function g(e,t,n){e.width=t.width*n,e.height=t.height*n,e.style.width=e.width/n+"px",e.style.height=e.height/n+"px"}function y(e,t){t.clearRect(t,0,0,e.width,e.height)}function b(n){if(typeof n=="function"){var r={png:t.toDataURL("image/png"),svg:e(i).fromImageSync(s).toSVGSync()};n(r)}}function w(e){var t={};for(var n in e){switch(n){case"blur":t[n]=parseInt(E(e[n],0,100,1,100),10);break;case"accuracy":t[n]=E(e[n],0,100,1,.1);break;case"vertex-count":t.vertexCount=parseInt(E(e[n],0,100,100,5e3),10)}t.fill=!!e.fill,t.gradients=!!e.gradients,t.gradientStops=2,t.strokeWidth=E(e["stroke-width"],0,100,0,100)}return t}function E(e,t,n,r,i){return r+(i-r)*(e-t)/(n-t)}var t=document.getElementById("canvas"),n=t.getContext("2d"),r=!1,i,s,o,u,a,f,l=window.devicePixelRatio&&window.devicePixelRatio>1?window.devicePixelRatio:1;return{init:c}}),define("src/image",[],function(){function i(n){e=n.signals,t=new Image,e["set-new-src"].add(o),t.addEventListener("load",s,!1),o(r)}function s(){e["image-loaded"].dispatch(t),n&&e["close-intro"].dispatch(),n=!0}function o(e){t.src=e,n&&t.naturalWidth!==undefined&&t.naturalWidth!==0&&setTimeout(s,10)}var e,t,n=!1,r=document.body.getAttribute("data-defaultimage");return{init:i}}),define("src/file",[],function(){function i(r){e=r.signals,n=r.feature,n["file-api"]&&(e["load-file"].add(s),t=new FileReader,t.addEventListener("load",o,!1))}function s(e){e&&e.type&&r.indexOf(e.type)!==-1&&t.readAsDataURL(e)}function o(t){e["set-new-src"].dispatch(t.target.result)}var e,t,n,r=["image/png","image/jpg","image/jpeg"];return{init:i}}),define("src/dragdrop",[],function(){function n(n){t=n.feature,e=n.signals,t["drag-drop"]&&(document.addEventListener("drop",i,!1),document.addEventListener("dragover",r,!1),document.addEventListener("dragleave",r,!1))}function r(e){e.preventDefault()}function i(t){t.preventDefault(),t.dataTransfer&&t.dataTransfer.files&&t.dataTransfer.files[0]&&(e["load-file"].dispatch(t.dataTransfer.files[0]),e["close-intro"].dispatch())}var e,t;return{init:n}}),define("src/controls",[],function(){function o(i){n=i.signals;if(i.feature["query-selector-all"]){var s=document.getElementById("controls");r=s.querySelectorAll(".control-input"),s.className+=" is-active";for(var o=0;o<r.length;o++){var p=r[o];p.addEventListener("change",u,!1),f(h(p.id),d(p)),l(c(p.id),d(p))}t=!0,n["control-set"].add(a),n["control-updated"].dispatch(e)}}function u(e){clearTimeout(i),i=setTimeout(function(){e.target&&(e=e.target),f(h(e.id),d(e)),l(c(e.id),d(e))},100)}function a(t){var r,i={};for(var s in t)r=c(s),p(r,t[s]),u(r),i[h(s)]=t[s];e=i,n["control-updated"].dispatch(e)}function f(r,i){typeof i!="undefined"&&(e[r]=i,t&&n["control-updated"].dispatch(e))}function l(e,t){e&&d(e)!==t&&typeof t!="undefined"&&p(e,t)}function c(e){var t,n=h(e),i;for(var s=0,o=r.length;s<o;s++){i=r[s].id;if(i.indexOf(n)!==-1)if(r[s].type==="checkbox"){if(i===e){t=r[s];break}}else if(i!==e){t=r[s];break}}return t}function h(e){return e.replace("-slider","").replace("-number","").replace("-input","")}function p(e,t){e[v(e)]=t}function d(e){return e[v(e)]}function v(e){return e.type==="checkbox"?"checked":"value"}var e={},t=!1,n,r,i,s=!1;return{init:o}}),define("src/export-button",[],function(){function i(i){e=i.signals,t=document.getElementById("export-button"),n=document.getElementById("png-link"),r=document.getElementById("svg-link"),t.addEventListener("click",s,!1),n.addEventListener("click",u,!1),r.addEventListener("click",a,!1)}function s(t){t.preventDefault(),e["export-requested"].dispatch(o)}function o(e){n.href=e.png,n.classList.add("is-active");var t=new Blob([e.svg],{type:"image/svg+xml"}),i=window.URL.createObjectURL(t);r.href=i,r.classList.add("is-active")}function u(){n.classList.remove("is-active")}function a(){r.classList.remove("is-active")}var e,t,n,r;return{init:i}}),define("util/trigger-event",[],function(){function e(e,t){var n;if(e.ownerDocument)n=e.ownerDocument;else{if(e.nodeType!==9)throw new Error("Invalid node passed to fireEvent: "+e.id);n=e}if(e.fireEvent){var r=n.createEventObject();r.synthetic=!0,e.fireEvent("on"+t,r)}else if(e.dispatchEvent){var i="";switch(t){case"click":case"mousedown":case"mouseup":i="MouseEvents";break;case"focus":case"change":case"blur":case"select":i="HTMLEvents";break;default:throw"triggerEvent: Couldnt find an event class for event "+t+"."}var r=n.createEvent(i),s=t=="change"?!1:!0;r.initEvent(t,s,!0),r.synthetic=!0,e.dispatchEvent(r)}}return e}),define("src/import-button",["util/trigger-event"],function(e){function a(e){n=e.signals,t=e.feature,t["file-api"]&&(s=new FileReader,r=document.getElementById("import-button"),i=document.getElementById("import-input"),r.addEventListener("click",f,!1),i.addEventListener("change",l,!1))}function f(t){t.preventDefault(),u||e(i,"click")}function l(e){var t=e.target.files;e.target&&e.target.files&&e.target.files[0]&&(n["load-file"].dispatch(e.target.files[0]),n["close-intro"].dispatch())}var t,n,r,i,s,o,u=!1;return{init:a}}),define("src/random-button",[],function(){function s(s){e=s.signals,s.feature["query-selector-all"]&&(t=document.querySelectorAll(".control-slider"),n=document.querySelectorAll(".checkbox"),i=a(t),r=document.getElementById("random-button"),r.addEventListener("click",o,!1),r.classList.remove("is-hidden"))}function o(e){e.preventDefault(),u()}function u(){var t={},r,s;for(var o in i)r=i[o],t[o]=f(r.min,r.max);for(var u=0,a=n.length;u<a;u++)s=n[u],t[s.id]=Math.random()>.5;e["control-set"].dispatch(t)}function a(e){var t={},n;for(var r=0,i=e.length;r<i;r++)n=e[r],t[n.id]={min:parseInt(n.min,10),max:parseInt(n.max,10)};return t}function f(e,t){return Math.floor(Math.random()*(t-e+1))+e}var e,t,n,r,i={};return{init:s}}),!function(e,t,n){typeof module!="undefined"&&module.exports?module.exports=n():typeof define=="function"&&define.amd?define("lib/reqwest",n):t[e]=n()}("reqwest",this,function(){function handleReadyState(e,t,n){return function(){if(e._aborted)return n(e.request);e.request&&e.request[readyState]==4&&(e.request.onreadystatechange=noop,twoHundo.test(e.request.status)?t(e.request):n(e.request))}}function setHeaders(e,t){var n=t.headers||{},r;n.Accept=n.Accept||defaultHeaders.accept[t.type]||defaultHeaders.accept["*"],!t.crossOrigin&&!n[requestedWith]&&(n[requestedWith]=defaultHeaders.requestedWith),n[contentType]||(n[contentType]=t.contentType||defaultHeaders.contentType);for(r in n)n.hasOwnProperty(r)&&"setRequestHeader"in e&&e.setRequestHeader(r,n[r])}function setCredentials(e,t){typeof t.withCredentials!="undefined"&&typeof e.withCredentials!="undefined"&&(e.withCredentials=!!t.withCredentials)}function generalCallback(e){lastValue=e}function urlappend(e,t){return e+(/\?/.test(e)?"&":"?")+t}function handleJsonp(e,t,n,r){var i=uniqid++,s=e.jsonpCallback||"callback",o=e.jsonpCallbackName||reqwest.getcallbackPrefix(i),u=new RegExp("((^|\\?|&)"+s+")=([^&]+)"),a=r.match(u),f=doc.createElement("script"),l=0,c=navigator.userAgent.indexOf("MSIE 10.0")!==-1;return a?a[3]==="?"?r=r.replace(u,"$1="+o):o=a[3]:r=urlappend(r,s+"="+o),win[o]=generalCallback,f.type="text/javascript",f.src=r,f.async=!0,typeof f.onreadystatechange!="undefined"&&!c&&(f.event="onclick",f.htmlFor=f.id="_reqwest_"+i),f.onload=f.onreadystatechange=function(){if(f[readyState]&&f[readyState]!=="complete"&&f[readyState]!=="loaded"||l)return!1;f.onload=f.onreadystatechange=null,f.onclick&&f.onclick(),t(lastValue),lastValue=undefined,head.removeChild(f),l=1},head.appendChild(f),{abort:function(){f.onload=f.onreadystatechange=null,n({},"Request is aborted: timeout",{}),lastValue=undefined,head.removeChild(f),l=1}}}function getRequest(e,t){var n=this.o,r=(n.method||"GET").toUpperCase(),i=typeof n=="string"?n:n.url,s=n.processData!==!1&&n.data&&typeof n.data!="string"?reqwest.toQueryString(n.data):n.data||null,o,u=!1;return(n.type=="jsonp"||r=="GET")&&s&&(i=urlappend(i,s),s=null),n.type=="jsonp"?handleJsonp(n,e,t,i):(o=xhr(n),o.open(r,i,n.async===!1?!1:!0),setHeaders(o,n),setCredentials(o,n),win[xDomainRequest]&&o instanceof win[xDomainRequest]?(o.onload=e,o.onerror=t,o.onprogress=function(){},u=!0):o.onreadystatechange=handleReadyState(this,e,t),n.before&&n.before(o),u?setTimeout(function(){o.send(s)},200):o.send(s),o)}function Reqwest(e,t){this.o=e,this.fn=t,init.apply(this,arguments)}function setType(e){var t=e.match(/\.(json|jsonp|html|xml)(\?|$)/);return t?t[1]:"js"}function init(o,fn){function complete(e){o.timeout&&clearTimeout(self.timeout),self.timeout=null;while(self._completeHandlers.length>0)self._completeHandlers.shift()(e)}function success(resp){resp=type!=="jsonp"?self.request:resp;var filteredResponse=globalSetupOptions.dataFilter(resp.responseText,type),r=filteredResponse;try{resp.responseText=r}catch(e){}if(r)switch(type){case"json":try{resp=win.JSON?win.JSON.parse(r):eval("("+r+")")}catch(err){return error(resp,"Could not parse JSON in response",err)}break;case"js":resp=eval(r);break;case"html":resp=r;break;case"xml":resp=resp.responseXML&&resp.responseXML.parseError&&resp.responseXML.parseError.errorCode&&resp.responseXML.parseError.reason?null:resp.responseXML}self._responseArgs.resp=resp,self._fulfilled=!0,fn(resp),self._successHandler(resp);while(self._fulfillmentHandlers.length>0)resp=self._fulfillmentHandlers.shift()(resp);complete(resp)}function error(e,t,n){e=self.request,self._responseArgs.resp=e,self._responseArgs.msg=t,self._responseArgs.t=n,self._erred=!0;while(self._errorHandlers.length>0)self._errorHandlers.shift()(e,t,n);complete(e)}this.url=typeof o=="string"?o:o.url,this.timeout=null,this._fulfilled=!1,this._successHandler=function(){},this._fulfillmentHandlers=[],this._errorHandlers=[],this._completeHandlers=[],this._erred=!1,this._responseArgs={};var self=this,type=o.type||setType(this.url);fn=fn||function(){},o.timeout&&(this.timeout=setTimeout(function(){self.abort()},o.timeout)),o.success&&(this._successHandler=function(){o.success.apply(o,arguments)}),o.error&&this._errorHandlers.push(function(){o.error.apply(o,arguments)}),o.complete&&this._completeHandlers.push(function(){o.complete.apply(o,arguments)}),this.request=getRequest.call(this,success,error)}function reqwest(e,t){return new Reqwest(e,t)}function normalize(e){return e?e.replace(/\r?\n/g,"\r\n"):""}function serial(e,t){var n=e.name,r=e.tagName.toLowerCase(),i=function(e){e&&!e.disabled&&t(n,normalize(e.attributes.value&&e.attributes.value.specified?e.value:e.text))},s,o,u,a;if(e.disabled||!n)return;switch(r){case"input":/reset|button|image|file/i.test(e.type)||(s=/checkbox/i.test(e.type),o=/radio/i.test(e.type),u=e.value,(!s&&!o||e.checked)&&t(n,normalize(s&&u===""?"on":u)));break;case"textarea":t(n,normalize(e.value));break;case"select":if(e.type.toLowerCase()==="select-one")i(e.selectedIndex>=0?e.options[e.selectedIndex]:null);else for(a=0;e.length&&a<e.length;a++)e.options[a].selected&&i(e.options[a])}}function eachFormElement(){var e=this,t,n,r=function(t,n){var r,i,s;for(r=0;r<n.length;r++){s=t[byTag](n[r]);for(i=0;i<s.length;i++)serial(s[i],e)}};for(n=0;n<arguments.length;n++)t=arguments[n],/input|select|textarea/i.test(t.tagName)&&serial(t,e),r(t,["input","select","textarea"])}function serializeQueryString(){return reqwest.toQueryString(reqwest.serializeArray.apply(null,arguments))}function serializeHash(){var e={};return eachFormElement.apply(function(t,n){t in e?(e[t]&&!isArray(e[t])&&(e[t]=[e[t]]),e[t].push(n)):e[t]=n},arguments),e}function buildParams(e,t,n,r){var i,s,o,u=/\[\]$/;if(isArray(t))for(s=0;t&&s<t.length;s++)o=t[s],n||u.test(e)?r(e,o):buildParams(e+"["+(typeof o=="object"?s:"")+"]",o,n,r);else if(t&&t.toString()==="[object Object]")for(i in t)buildParams(e+"["+i+"]",t[i],n,r);else r(e,t)}var win=window,doc=document,twoHundo=/^20\d$/,byTag="getElementsByTagName",readyState="readyState",contentType="Content-Type",requestedWith="X-Requested-With",head=doc[byTag]("head")[0],uniqid=0,callbackPrefix="reqwest_"+ +(new Date),lastValue,xmlHttpRequest="XMLHttpRequest",xDomainRequest="XDomainRequest",noop=function(){},isArray=typeof Array.isArray=="function"?Array.isArray:function(e){return e instanceof Array},defaultHeaders={contentType:"application/x-www-form-urlencoded",requestedWith:xmlHttpRequest,accept:{"*":"text/javascript, text/html, application/xml, text/xml, */*",xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",js:"application/javascript, text/javascript"}},xhr=function(e){if(e.crossOrigin===!0){var t=win[xmlHttpRequest]?new XMLHttpRequest:null;if(t&&"withCredentials"in t)return t;if(win[xDomainRequest])return new XDomainRequest;throw new Error("Browser does not support cross-origin requests")}return win[xmlHttpRequest]?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},globalSetupOptions={dataFilter:function(e){return e}};return Reqwest.prototype={abort:function(){this._aborted=!0,this.request.abort()},retry:function(){init.call(this,this.o,this.fn)},then:function(e,t){return e=e||function(){},t=t||function(){},this._fulfilled?this._responseArgs.resp=e(this._responseArgs.resp):this._erred?t(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):(this._fulfillmentHandlers.push(e),this._errorHandlers.push(t)),this},always:function(e){return this._fulfilled||this._erred?e(this._responseArgs.resp):this._completeHandlers.push(e),this},fail:function(e){return this._erred?e(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):this._errorHandlers.push(e),this}},reqwest.serializeArray=function(){var e=[];return eachFormElement.apply(function(t,n){e.push({name:t,value:n})},arguments),e},reqwest.serialize=function(){if(arguments.length===0)return"";var e,t,n=Array.prototype.slice.call(arguments,0);return e=n.pop(),e&&e.nodeType&&n.push(e)&&(e=null),e&&(e=e.type),e=="map"?t=serializeHash:e=="array"?t=reqwest.serializeArray:t=serializeQueryString,t.apply(null,n)},reqwest.toQueryString=function(e,t){var n,r,i=t||!1,s=[],o=encodeURIComponent,u=function(e,t){t="function"==typeof t?t():t==null?"":t,s[s.length]=o(e)+"="+o(t)};if(isArray(e))for(r=0;e&&r<e.length;r++)u(e[r].name,e[r].value);else for(n in e)buildParams(n,e[n],i,u);return s.join("&").replace(/%20/g,"+")},reqwest.getcallbackPrefix=function(){return callbackPrefix},reqwest.compat=function(e,t){return e&&(e.type&&(e.method=e.type)&&delete e.type,e.dataType&&(e.type=e.dataType),e.jsonpCallback&&(e.jsonpCallbackName=e.jsonpCallback)&&delete e.jsonpCallback,e.jsonp&&(e.jsonpCallback=e.jsonp)),new Reqwest(e,t)},reqwest.ajaxSetup=function(e){e=e||{};for(var t in e)globalSetupOptions[t]=e[t]},reqwest}),define("src/upload-imgur",["lib/reqwest"],function(e,t){function h(e){n=e.signals,r=document.getElementById("imgur-button"),i=document.getElementById("imgur-url-container"),s=document.getElementById("imgur-url-input"),o=document.getElementById("imgur-url-link"),u=document.getElementById("imgur-url-error"),a=document.getElementById("twitter-link"),f=document.getElementById("facebook-link"),l=document.getElementById("reddit-link"),r.addEventListener("click",p,!1),s.addEventListener("click",d,!1)}function p(e){e.preventDefault(),c||(n["export-requested"].dispatch(v),i.classList.remove("is-active","upload-failed","upload-successful"))}function d(){s.select()}function v(t){c||(r.classList.add("is-uploading"),c=!0,e({url:"https://api.imgur.com/3/image.json",method:"POST",headers:{Authorization:"Client-ID a4c24380d884932"},data:{image:t.png.split(",")[1],type:"base64"},type:"json",crossOrigin:!0,success:m,error:g}))}function m(e){c=!1;if(e&&e.data&&e.data.link){var t="Check out what I made with @snorpeys triangulation tool: ";t+=e.data.link,t+=" http://snorpey.github.io/triangulation";var n="https://www.facebook.com/sharer/sharer.php?s=100";n+="&p[url]="+e.data.link,n+="&p[title]=Triangles!",n+="&p[images][0]="+e.data.link,n+="&p[summary]="+encodeURIComponent("Check out what I made with this triangulation tool: http://snorpey.github.io/triangulation"),r.classList.remove("is-uploading"),s.setAttribute("value",e.data.link),o.href=e.data.link,i.classList.add("is-active","upload-successful"),a.href="https://twitter.com/intent/tweet?text="+encodeURIComponent(t),f.href=n,l.href="https://www.reddit.com/submit?url="+encodeURIComponent(e.data.link)+"&title=Triangles!"}else g()}function g(e){c=!1,r.classList.remove("is-uploading"),i.classList.add("is-active","upload-failed")}var n,r,i,s,o,u,a,f,l,c=!1;return{init:h}}),define("src/intro",[],function(){function s(t){e=t.signals,r.addEventListener("click",o),i.addEventListener("click",a),e["close-intro"].add(a)}function o(e){t?a():u()}function u(){r.classList.add("is-active"),n.classList.add("is-active"),t=!0}function a(){r.classList.remove("is-active"),n.classList.remove("is-active"),t=!1}var e,t=!0,n=document.querySelectorAll(".intro")[0],r=document.querySelectorAll(".intro-button")[0],i=n.querySelectorAll(".close")[0];return{init:s}}),function(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||!1}(),define("lib/getusermedia",function(){}),define("src/cam",["lib/getusermedia"],function(){function u(r){o=r.signals;if(navigator.getUserMedia){e.classList.add("is-supported"),e.addEventListener("click",a),t=document.createElement("div"),t.classList.add("cam-wrapper");var s=document.createElement("div");s.textContent="Take Picture",s.classList.add("take-picture"),s.classList.add("button"),s.addEventListener("click",c),t.appendChild(s),n=document.createElement("video"),n.classList.add("cam"),n.addEventListener("click",c),t.appendChild(n),document.body.appendChild(t),i=document.createElement("canvas")}}function a(e){var t={video:!0};navigator.getUserMedia(t,f,l)}function f(e){var o;window.webkitURL?o=window.URL.createObjectURL(e):o=e,n.mozSrcObject!==undefined?n.mozSrcObject=o:n.src=o,r=e,n.play(),n.style.display="block",t.classList.add("is-active"),i.width=640,i.height=480,s=i.getContext("2d")}function l(){console.log("sorry, but there was an error accessing you camera...")}function c(e){s.translate(i.width,0),s.scale(-1,1),s.drawImage(n,0,0);var u=s.getImageData(0,0,i.width,i.height),a=i.toDataURL("image/png");t.classList.remove("is-active"),o["set-new-src"].dispatch(a),setTimeout(function(){r.stop()},500)}var e=document.getElementById("cam-button"),t,n,r,i,s,o;return{init:u}}),define("util/feature-test",[],function(){function t(t,n){var r=!0,i={},s=[];for(var o in e){var u=e[o].test();u||e[o].required&&(r=!1,s.push(o)),i[o]=u}r?t(i):n(s,i)}var e={canvas:{required:!0,test:function(){return!!document.createElement("canvas").getContext}},"query-selector-all":{required:!1,test:function(){return!!document.querySelectorAll}},"drag-drop":{required:!1,test:function(){return"draggable"in document.createElement("span")}},"file-api":{required:!1,test:function(){return typeof FileReader!="undefined"}}};return t}),function(e){function t(e,t,n,r,i){this._listener=t,this._isOnce=n,this.context=r,this._signal=e,this._priority=i||0}function n(e,t){if(typeof e!="function")throw new Error("listener is a required param of {fn}() and should be a Function.".replace("{fn}",t))}function r(){this._bindings=[],this._prevParams=null;var e=this;this.dispatch=function(){r.prototype.dispatch.apply(e,arguments)}}t.prototype={active:!0,params:null,execute:function(e){var t,n;return this.active&&!!this._listener&&(n=this.params?this.params.concat(e):e,t=this._listener.apply(this.context,n),this._isOnce&&this.detach()),t},detach:function(){return this.isBound()?this._signal.remove(this._listener,this.context):null},isBound:function(){return!!this._signal&&!!this._listener},isOnce:function(){return this._isOnce},getListener:function(){return this._listener},getSignal:function(){return this._signal},_destroy:function(){delete this._signal,delete this._listener,delete this.context},toString:function(){return"[SignalBinding isOnce:"+this._isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}},r.prototype={VERSION:"1.0.0",memorize:!1,_shouldPropagate:!0,active:!0,_registerListener:function(e,n,r,i){var s=this._indexOfListener(e,r),o;if(s!==-1){o=this._bindings[s];if(o.isOnce()!==n)throw new Error("You cannot add"+(n?"":"Once")+"() then add"+(n?"Once":"")+"() the same listener without removing the relationship first.")}else o=new t(this,e,n,r,i),this._addBinding(o);return this.memorize&&this._prevParams&&o.execute(this._prevParams),o},_addBinding:function(e){var t=this._bindings.length;do--t;while(this._bindings[t]&&e._priority<=this._bindings[t]._priority);this._bindings.splice(t+1,0,e)},_indexOfListener:function(e,t){var n=this._bindings.length,r;while(n--){r=this._bindings[n];if(r._listener===e&&r.context===t)return n}return-1},has:function(e,t){return this._indexOfListener(e,t)!==-1},add:function(e,t,r){return n(e,"add"),this._registerListener(e,!1,t,r)},addOnce:function(e,t,r){return n(e,"addOnce"),this._registerListener(e,!0,t,r)},remove:function(e,t){n(e,"remove");var r=this._indexOfListener(e,t);return r!==-1&&(this._bindings[r]._destroy(),this._bindings.splice(r,1)),e},removeAll:function(){var e=this._bindings.length;while(e--)this._bindings[e]._destroy();this._bindings.length=0},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(e){if(!this.active)return;var t=Array.prototype.slice.call(arguments),n=this._bindings.length,r;this.memorize&&(this._prevParams=t);if(!n)return;r=this._bindings.slice(),this._shouldPropagate=!0;do n--;while(r[n]&&this._shouldPropagate&&r[n].execute(t)!==!1)},forget:function(){this._prevParams=null},dispose:function(){this.removeAll(),delete this._bindings,delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}};var i=r;i.Signal=r,typeof define=="function"&&define.amd?define("lib/signals-1.0.0",[],function(){return i}):typeof module!="undefined"&&module.exports?module.exports=i:e.signals=i}(this);var path=typeof _basepath_=="string"?_basepath_+"/":"";requirejs.config({baseUrl:path+"scripts/",waitSeconds:50,urlArgs:"bust="+(new Date).getTime()}),require(["src/process","src/image","src/file","src/dragdrop","src/controls","src/export-button","src/import-button","src/random-button","src/upload-imgur","src/intro","src/cam","util/feature-test","lib/signals-1.0.0"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){function p(c){var p={feature:c,signals:{"load-file":new h,"image-loaded":new h,"set-new-src":new h,"control-set":new h,"control-updated":new h,"close-intro":new h,"export-requested":new h}};e.init(p),r.init(p),i.init(p),s.init(p),o.init(p),u.init(p),t.init(p),n.init(p),a.init(p),f.init(p),l.init(p)}function d(e){var t=document.createElement("div"),n="sorry. it looks like your browser is missing some of the features ";n+="("+e.join(", ")+") that are required to run this ",n+="experiment.",t.innerText=n,t.className="missing-feature",document.getElementsByTagName("body")[0].appendChild(t)}c(p,d)}),define("main",function(){})})();